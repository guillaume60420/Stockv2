<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2MI - Gestion Stock Filtres</title>
    
    <!-- Nouvelle Librairie Scanner plus robuste -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #E30066;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 1.8em;
            color: #E30066;
            margin-bottom: 5px;
            font-weight: 900;
        }

        .header p {
            color: #333;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Machine Selection - G√©n√©r√© Dynamiquement */
        .machine-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .machine-selection.hidden {
            display: none;
        }

        .machine-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .machine-card:active {
            transform: scale(0.95);
        }

        .machine-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .machine-name {
            font-size: 1em;
            font-weight: 900;
            color: #E30066;
            text-transform: uppercase;
        }

        /* Machine Header */
        .machine-header {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .machine-header.active {
            display: block;
        }

        .machine-header h2 {
            color: #E30066;
            font-size: 1.5em;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .machine-header button {
            background: #6c757d;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: white;
            font-weight: 900;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Menu Buttons */
        .menu-buttons {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-buttons.active {
            display: grid;
        }

        .menu-btn {
            background: white;
            border: none;
            border-radius: 10px;
            padding: 25px 15px;
            font-size: 1.1em;
            font-weight: 900;
            color: #E30066;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .menu-btn:active {
            transform: scale(0.95);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.5em;
            color: #E30066;
            margin-bottom: 20px;
            font-weight: 900;
        }

        /* Stock Display */
        .category-section {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 1.3em;
            color: #E30066;
            font-weight: 900;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stock-items {
            display: grid;
            gap: 15px;
            padding-left: 10px;
        }

        .stock-item {
            background: #f8f9fa;
            border: 2px solid #E30066;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stock-name {
            font-size: 1.1em;
            font-weight: 900;
            color: #E30066;
        }

        .stock-quantity {
            font-size: 1.8em;
            font-weight: 900;
            color: #E30066;
        }

        /* Drawer Visualization */
        .drawer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .drawer.open {
            max-height: 800px;
        }

        .drawer-content {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            gap: 8px;
        }

        .item-box {
            aspect-ratio: 1;
            background: #E30066;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 900;
            color: white;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #E30066;
            margin-bottom: 8px;
            font-weight: 900;
            font-size: 1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 2px solid #E30066;
            border-radius: 8px;
            color: #333;
            font-size: 1em;
            font-weight: 600;
        }

        .btn {
            background: #E30066;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-size: 1.1em;
            font-weight: 900;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-scan {
            background: #28a745;
            margin-bottom: 15px;
        }

        .back-btn {
            background: #6c757d;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 900;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-block;
        }

        /* SCANNER INTERFACE STYLE (HTML5-QRCODE) */
        #reader {
            width: 100%;
            background: black;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #scanner-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Suggestions */
        .suggestions-list {
            background: white;
            border: 2px solid #E30066;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .suggestions-list.active { display: block; }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f8f9fa; font-weight: 600; }

        /* Retrait liste */
        .retrait-liste {
            background: #f8f9fa;
            border: 2px solid #E30066;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .retrait-liste-item {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px;
            border: 1px solid #dee2e6;
        }
        .retrait-liste-item-remove {
            background: #dc3545; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; cursor: pointer; font-weight: 900;
        }

        /* Engins Liste */
        .engin-item {
            background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px;
            padding: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
        }
        .engin-item.selected { border-color: #28a745; background: #d4edda; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        .alert-danger { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .alert-success { background: #d4edda; border: 2px solid #28a745; color: #155724; }
    </style>
</head>
<body>
    
    <!-- SCANNER MODAL -->
    <div id="scanner-modal">
        <h2 style="color:white; margin-bottom:10px;">üì∑ Scanner un Code</h2>
        <div id="reader" style="width: 300px; height: 300px;"></div>
        <button onclick="fermerScanner()" class="btn" style="margin-top:20px; background: #dc3545;">Fermer</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîß C2MI - Gestion Stock</h1>
            <p>G√©rez vos filtres comme un chef</p>
        </div>

        <!-- Machine Selection (Rempli dynamiquement par JS) -->
        <div class="machine-selection" id="machineSelection">
            <!-- Les boutons seront g√©n√©r√©s ici -->
        </div>

        <!-- Machine Header -->
        <div class="machine-header" id="machineHeader">
            <h2 id="machineHeaderName"></h2>
            <button onclick="backToMachines()">‚¨ÖÔ∏è Changer de machine</button>
        </div>

        <!-- Menu Buttons -->
        <div class="menu-buttons" id="menuButtons">
            <button class="menu-btn" onclick="showSection('stock')">üì¶ STOCK</button>
            <button class="menu-btn" onclick="showSection('ajouter')">‚ûï AJOUTER</button>
            <button class="menu-btn" onclick="showSection('retirer')">‚ûñ RETIRER</button>
            <button class="menu-btn" onclick="showSection('prevision')">üìä PR√âVISION</button>
        </div>

        <!-- Stock Section -->
        <div class="content-section" id="stockSection">
            <button class="back-btn" onclick="backToMenu()">‚¨ÖÔ∏è Retour</button>
            <h2 class="section-title">üì¶ Stock - <span id="stockMachineName"></span></h2>
            <div class="stock-items" id="stockItems"></div>
        </div>

        <!-- Ajouter Section -->
        <div class="content-section" id="ajouterSection">
            <button class="back-btn" onclick="backToMenu()">‚¨ÖÔ∏è Retour</button>
            <h2 class="section-title">‚ûï Ajouter au Stock</h2>
            
            <button class="btn btn-scan" onclick="demarrerScanner()">üì∑ Scanner Code-Barres</button>

            <div class="form-group">
                <label>Code-Barres</label>
                <input type="text" id="scanInput" placeholder="Code scann√© ou manuel">
            </div>

            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="categorieSelect" onchange="updateFiltreTypes()">
                    <option value="">-- S√©lectionner --</option>
                </select>
                <button class="btn" style="background:#17a2b8; margin-top:5px;" onclick="ajouterCategorie()">‚ûï Nouvelle Cat√©gorie</button>
            </div>

            <div class="form-group suggestions">
                <label>Type de Pi√®ce</label>
                <input type="text" id="filtreTypeInput" placeholder="Tapez le nom..." oninput="showSuggestions()" onfocus="showSuggestions()" disabled>
                <div class="suggestions-list" id="suggestionsList"></div>
            </div>

            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="quantiteAjout" min="1" value="1">
            </div>

            <button class="btn" onclick="ajouterStock()">Ajouter au Stock</button>
        </div>

        <!-- Retirer Section -->
        <div class="content-section" id="retirerSection">
            <button class="back-btn" onclick="backToMenu()">‚¨ÖÔ∏è Retour</button>
            <h2 class="section-title">‚ûñ Retirer du Stock</h2>

            <h3 style="color: #E30066; margin: 15px 0;">Retrait par Kit</h3>
            <button class="btn" onclick="retirerKitFiltration()">üîß Kit Filtration Complet</button>

            <h3 style="color: #E30066; margin: 20px 0 15px 0;">Liste de Retrait</h3>
            <div class="retrait-liste">
                <div class="retrait-liste-items" id="retraitListeItems"></div>
            </div>
            <button class="btn" onclick="validerRetraitListe()" id="btnValiderRetrait" style="display: none;">‚úÖ Valider le Retrait</button>

            <h3 style="color: #E30066; margin: 20px 0 15px 0;">Ajouter √† la liste</h3>
            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="categorieRetraitSelect" onchange="updateRetraitTypes()"><option value="">-- S√©lectionner --</option></select>
            </div>
            <div class="form-group suggestions">
                <label>Type de Pi√®ce</label>
                <input type="text" id="filtreTypeRetraitInput" placeholder="Nom..." oninput="showRetraitSuggestions()" onfocus="showRetraitSuggestions()" disabled>
                <div class="suggestions-list" id="retraitSuggestionsList"></div>
            </div>
            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="quantiteRetrait" min="1" value="1">
            </div>
            <button class="btn" style="background:#6c757d;" onclick="ajouterAListeRetrait()">‚ûï Ajouter √† la Liste</button>
        </div>

        <!-- Pr√©vision Section -->
        <div class="content-section" id="previsionSection">
            <button class="back-btn" onclick="backToMenu()">‚¨ÖÔ∏è Retour</button>
            <h2 class="section-title">üìä Pr√©vision Maintenance</h2>
            <div id="enginsListe" class="engins-liste"></div>
            <button class="btn" onclick="calculerPrevisions()">üîç Calculer</button>
            <div id="alertesStock"></div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDR1T9ss36NFuQWvq3ypwf7nUcqRhq5dQ8",
            authDomain: "maintenance-c2mi.firebaseapp.com",
            databaseURL: "https://maintenance-c2mi-default-rtdb.firebaseio.com",
            projectId: "maintenance-c2mi",
            storageBucket: "maintenance-c2mi.firebasestorage.app",
            messagingSenderId: "224545367081",
            appId: "1:224545367081:web:378d28b892528754c6a838"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // --- LISTE DES ENGINS SYNCHRONIS√âE (Copie exacte de Version Finale) ---
        const dbEngins = {
            "4' AXE": ["TR 020", "TR 062", "TR 083", "TR 104", "TR 111", "TR 116", "TR 127", "TR 136", "TR 141"],
            "ELAN": ["C3 N¬∞235", "ELAN D : 032"],
            "SKYRAILLER": ["C14 N¬∞32", "C14 green N¬∞83"],
            "Pelle UNAC 22 TRR": ["N¬∞ 051", "N¬∞ 086", "N¬∞ 088"],
            "Debroussailleuse R/R": ["300RR N¬∞23", "300RR N¬∞24", "N¬∞ 27", "N¬∞ 30"],
            "ACX": ["ACX 01", "ACX 02"]
        };

        // --- VARIABLES GLOBALES ---
        let currentMachine = '';
        let stockData = {};
        let categoriesData = { filtration: { name: 'Filtration', types: [] } };
        let retraitListe = [];
        let enginsC2MI = {}; // Sera rempli par Firebase ou dbEngins
        let html5QrcodeScanner = null;

        // --- INITIALISATION DES MACHINES (HOME) ---
        function initMachineMenu() {
            const container = document.getElementById('machineSelection');
            container.innerHTML = '';
            
            // Ic√¥nes par type pour faire joli
            const icons = {
                "4' AXE": "üöÇ",
                "ELAN": "üöÖ",
                "SKYRAILLER": "üöÑ",
                "Pelle UNAC 22 TRR": "üèóÔ∏è",
                "Debroussailleuse R/R": "üåø",
                "ACX": "üöÜ"
            };

            for (const [type, machines] of Object.entries(dbEngins)) {
                const icon = icons[type] || "üöú";
                const div = document.createElement('div');
                div.className = 'machine-card';
                div.onclick = () => selectMachine(type); // On s√©lectionne le TYPE (ex: 4'AXE)
                div.innerHTML = `
                    <div class="machine-icon">${icon}</div>
                    <div class="machine-name">${type}</div>
                `;
                container.appendChild(div);
            }
        }

        // --- NOUVEAU SCANNER (HTML5-QRCODE) ---
        window.demarrerScanner = function() {
            document.getElementById('scanner-modal').style.display = 'flex';
            
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // Pr√©f√©rence pour la cam√©ra arri√®re
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                alert("Erreur d√©marrage cam√©ra : " + err);
            });
        };

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code scann√© = ${decodedText}`, decodedResult);
            document.getElementById('scanInput').value = decodedText;
            
            // Bruit de bip (optionnel)
            const audio = new AudioContext();
            const osc = audio.createOscillator();
            const gain = audio.createGain();
            osc.connect(gain);
            gain.connect(audio.destination);
            osc.frequency.value = 800;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 100);

            fermerScanner();
        }

        function onScanFailure(error) {
            // Pas d'alerte ici, sinon √ßa spamme la console tant qu'il cherche
        }

        window.fermerScanner = function() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById('scanner-modal').style.display = 'none';
                }).catch(err => console.error("Erreur stop", err));
            } else {
                document.getElementById('scanner-modal').style.display = 'none';
            }
        };

        // --- FONCTIONS FIREBASE ---
        function initCategories() {
            const categoriesRef = ref(database, 'categories_stock');
            get(categoriesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    categoriesData = snapshot.val();
                } else {
                    // Init par d√©faut si vide
                    categoriesData.filtration.types = ['Filtre √† Huile', 'Filtre √† Gasoil', 'Pr√©-Filtre', 'Filtre √† Air'];
                    set(categoriesRef, categoriesData);
                }
                updateCategorieSelects();
            });
        }

        function updateCategorieSelects() {
            const selects = ['categorieSelect', 'categorieRetraitSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- S√©lectionner --</option>';
                for (let [key, data] of Object.entries(categoriesData)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = data.name;
                    select.appendChild(option);
                }
            });
        }

        window.ajouterCategorie = function() {
            const nom = prompt('Nom de la nouvelle cat√©gorie :');
            if (!nom) return;
            const key = nom.toLowerCase().replace(/\s+/g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            if (categoriesData[key]) { alert('Existe d√©j√† !'); return; }
            
            categoriesData[key] = { name: nom, types: [] };
            set(ref(database, 'categories_stock'), categoriesData);
            updateCategorieSelects();
            alert('‚úÖ Cat√©gorie cr√©√©e !');
        };

        // --- NAVIGATION ---
        window.selectMachine = function(machineType) {
            currentMachine = machineType;
            document.getElementById('machineSelection').classList.add('hidden');
            document.getElementById('machineHeader').classList.add('active');
            document.getElementById('machineHeaderName').textContent = machineType;
            document.getElementById('menuButtons').classList.add('active');
            
            // Chargement des donn√©es
            loadStockData();
            // On pr√©pare la liste des engins sp√©cifiques pour la pr√©vision
            prepareEnginsListForPrevision(machineType);
        };

        window.backToMachines = function() {
            document.getElementById('menuButtons').classList.remove('active');
            document.getElementById('machineHeader').classList.remove('active');
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById('machineSelection').classList.remove('hidden');
            currentMachine = '';
        };

        window.showSection = function(section) {
            document.getElementById('menuButtons').classList.remove('active');
            document.getElementById('machineHeader').classList.remove('active');
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            
            if (section === 'stock') displayStock();
            if (section === 'retirer') { updateCategorieSelects(); displayRetraitListe(); }
            if (section === 'prevision') displayEnginsForPrevision();
        };

        window.backToMenu = function() {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById('menuButtons').classList.add('active');
            document.getElementById('machineHeader').classList.add('active');
        };

        // --- GESTION DU STOCK ---
        function loadStockData() {
            const stockRef = ref(database, 'stock_filtres_v2/' + currentMachine);
            onValue(stockRef, (snapshot) => {
                stockData[currentMachine] = snapshot.val() || {};
                // Si on est sur la page stock, on rafraichit l'affichage
                if(document.getElementById('stockSection').classList.contains('active')) displayStock();
            });
        }

        function displayStock() {
            const container = document.getElementById('stockItems');
            document.getElementById('stockMachineName').textContent = currentMachine;
            container.innerHTML = '';
            const stock = stockData[currentMachine] || {};

            for (let [catKey, catData] of Object.entries(categoriesData)) {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `<div class="category-title">üìÅ ${catData.name}</div>`;
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'stock-items';
                
                const catStock = stock[catKey] || {};
                // Fusionner les types d√©finis et ceux en stock (au cas o√π)
                const types = new Set([...(catData.types || []), ...Object.keys(catStock)]);

                if (types.size === 0) continue;

                types.forEach(type => {
                    const items = catStock[type] || [];
                    const qty = items.length;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'stock-item';
                    itemDiv.innerHTML = `
                        <div class="stock-header">
                            <div class="stock-name">${type}</div>
                            <div class="stock-quantity">${qty}</div>
                        </div>
                        <div class="drawer" id="drawer-${catKey}-${type.replace(/\s+/g,'_')}">
                            <div class="drawer-content">
                                <div class="items-grid">
                                    ${items.map((it, i) => `<div class="item-box" title="${it.code}">${i+1}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    itemDiv.onclick = () => {
                        itemDiv.querySelector('.drawer').classList.toggle('open');
                    };
                    itemsDiv.appendChild(itemDiv);
                });
                section.appendChild(itemsDiv);
                container.appendChild(section);
            }
        }

        window.ajouterStock = function() {
            const code = document.getElementById('scanInput').value;
            const cat = document.getElementById('categorieSelect').value;
            const type = document.getElementById('filtreTypeInput').value.trim();
            const qty = parseInt(document.getElementById('quantiteAjout').value);

            if (!cat || !type || !qty) return alert('Remplissez tout !');

            if (!stockData[currentMachine]) stockData[currentMachine] = {};
            if (!stockData[currentMachine][cat]) stockData[currentMachine][cat] = {};
            if (!stockData[currentMachine][cat][type]) stockData[currentMachine][cat][type] = [];

            // Ajout du type s'il n'existe pas dans la cat√©gorie
            if (!categoriesData[cat].types.includes(type)) {
                categoriesData[cat].types.push(type);
                set(ref(database, 'categories_stock'), categoriesData);
            }

            for(let i=0; i<qty; i++) {
                stockData[currentMachine][cat][type].push({ code: code, date: new Date().toISOString() });
            }

            set(ref(database, 'stock_filtres_v2/' + currentMachine), stockData[currentMachine]);
            alert('‚úÖ Ajout√© !');
            document.getElementById('scanInput').value = '';
        };

        // --- AUTOCOMPLETE ---
        window.updateFiltreTypes = function() {
            const cat = document.getElementById('categorieSelect').value;
            const input = document.getElementById('filtreTypeInput');
            input.disabled = !cat;
            input.value = '';
        };

        window.showSuggestions = function() {
            const cat = document.getElementById('categorieSelect').value;
            if(!cat) return;
            const input = document.getElementById('filtreTypeInput');
            const val = input.value.toLowerCase();
            const list = document.getElementById('suggestionsList');
            const types = categoriesData[cat].types || [];
            const filtered = types.filter(t => t.toLowerCase().includes(val));

            list.innerHTML = '';
            filtered.forEach(t => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = t;
                div.onclick = () => { input.value = t; list.classList.remove('active'); };
                list.appendChild(div);
            });
            
            // Option de cr√©ation
            if(val.length > 0 && !filtered.includes(input.value)) {
                const create = document.createElement('div');
                create.className = 'suggestion-item';
                create.innerHTML = `<strong>‚ûï Cr√©er "${input.value}"</strong>`;
                create.onclick = () => list.classList.remove('active');
                list.appendChild(create);
            }
            list.classList.add('active');
        };

        // --- RETRAIT ---
        window.updateRetraitTypes = function() {
            const cat = document.getElementById('categorieRetraitSelect').value;
            document.getElementById('filtreTypeRetraitInput').disabled = !cat;
        };

        window.showRetraitSuggestions = function() {
            const cat = document.getElementById('categorieRetraitSelect').value;
            if(!cat) return;
            const input = document.getElementById('filtreTypeRetraitInput');
            const val = input.value.toLowerCase();
            const list = document.getElementById('retraitSuggestionsList');
            
            const types = [];
            if(stockData[currentMachine] && stockData[currentMachine][cat]) {
                types.push(...Object.keys(stockData[currentMachine][cat]));
            }
            const filtered = types.filter(t => t.toLowerCase().includes(val));
            
            list.innerHTML = '';
            filtered.forEach(t => {
                const qty = stockData[currentMachine][cat][t].length;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = `${t} (${qty} dispo)`;
                div.onclick = () => { input.value = t; list.classList.remove('active'); };
                list.appendChild(div);
            });
            list.classList.add('active');
        };

        window.ajouterAListeRetrait = function() {
            const cat = document.getElementById('categorieRetraitSelect').value;
            const type = document.getElementById('filtreTypeRetraitInput').value;
            const qty = parseInt(document.getElementById('quantiteRetrait').value);
            
            if(!cat || !type) return;
            
            // V√©rif stock
            const dispo = (stockData[currentMachine]?.[cat]?.[type] || []).length;
            if(dispo < qty) return alert(`Stock insuffisant (${dispo} dispo)`);

            retraitListe.push({ cat, type, qty });
            displayRetraitListe();
        };

        function displayRetraitListe() {
            const cont = document.getElementById('retraitListeItems');
            const btn = document.getElementById('btnValiderRetrait');
            cont.innerHTML = '';
            if(retraitListe.length === 0) {
                cont.innerHTML = '<div style="text-align:center;color:#666">Vide</div>';
                btn.style.display = 'none';
            } else {
                retraitListe.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'retrait-liste-item';
                    div.innerHTML = `<span>${item.qty}x ${item.type}</span> <button class="retrait-liste-item-remove" onclick="window.retirerItem(${idx})">X</button>`;
                    cont.appendChild(div);
                });
                btn.style.display = 'block';
            }
        }

        window.retirerItem = function(idx) {
            retraitListe.splice(idx, 1);
            displayRetraitListe();
        };

        window.validerRetraitListe = function() {
            retraitListe.forEach(item => {
                for(let i=0; i<item.qty; i++) {
                    stockData[currentMachine][item.cat][item.type].pop();
                }
            });
            set(ref(database, 'stock_filtres_v2/' + currentMachine), stockData[currentMachine]);
            retraitListe = [];
            displayRetraitListe();
            alert('‚úÖ Stock mis √† jour !');
        };

        // --- PREVISIONS ---
        function prepareEnginsListForPrevision(typeMachine) {
            // Ici, on utilise la liste dbEngins pour savoir quels engins existent pour ce type
            enginsC2MI[typeMachine] = dbEngins[typeMachine].map(nom => ({ nom: nom, type: typeMachine }));
        }

        function displayEnginsForPrevision() {
            const cont = document.getElementById('enginsListe');
            const engins = enginsC2MI[currentMachine] || [];
            cont.innerHTML = '';
            
            engins.forEach((engin, i) => {
                const div = document.createElement('div');
                div.className = 'engin-item';
                div.id = `engin-${i}`;
                div.innerHTML = `
                    <input type="checkbox" id="check-${i}" onchange="toggleDate(${i})">
                    <div style="flex:1"><strong>${engin.nom}</strong></div>
                    <input type="date" id="date-${i}" disabled style="padding:5px;">
                `;
                cont.appendChild(div);
            });
        }

        window.toggleDate = function(i) {
            const chk = document.getElementById(`check-${i}`);
            const date = document.getElementById(`date-${i}`);
            const item = document.getElementById(`engin-${i}`);
            date.disabled = !chk.checked;
            if(chk.checked) {
                date.valueAsDate = new Date();
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        };

        window.calculerPrevisions = function() {
            const engins = enginsC2MI[currentMachine] || [];
            let interventions = 0;
            engins.forEach((e, i) => {
                if(document.getElementById(`check-${i}`).checked) interventions++;
            });

            if(interventions === 0) return alert('S√©lectionnez au moins un engin !');

            const alertDiv = document.getElementById('alertesStock');
            let html = '<h3>üö® Analyse Stock</h3>';
            
            // On v√©rifie les filtres principaux
            const typesCritiques = ['Filtre √† Huile', 'Filtre √† Gasoil', 'Filtre √† Air'];
            
            typesCritiques.forEach(type => {
                // On cherche dans toutes les cat√©gories si ce filtre existe
                let stockTotal = 0;
                // G√©n√©ralement dans "filtration" mais on check partout
                if(stockData[currentMachine] && stockData[currentMachine]['filtration'] && stockData[currentMachine]['filtration'][type]) {
                    stockTotal = stockData[currentMachine]['filtration'][type].length;
                }

                if(stockTotal < interventions) {
                    html += `<div class="alert alert-danger">‚ö†Ô∏è <strong>${type}</strong> : Manque ${interventions - stockTotal} pi√®ce(s) ! (Stock: ${stockTotal})</div>`;
                } else {
                    html += `<div class="alert alert-success">‚úÖ <strong>${type}</strong> : OK (${stockTotal} en stock)</div>`;
                }
            });
            alertDiv.innerHTML = html;
        };

        // --- LANCEMENT ---
        initMachineMenu();
        initCategories();

    </script>
</body>
</html>

