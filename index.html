<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2MI STOCK - MASTER V6</title>
    
    <style>
        :root { --primary: #E30066; --bg: #f4f4f9; --text: #333; --dark: #880e4f; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--primary); color: white; padding-bottom: 100px; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }

        /* HEADER */
        .header { background: white; color: var(--primary); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .header h1 { font-weight: 900; font-size: 1.8rem; text-transform: uppercase; }

        /* MACHINES */
        .grid-machines { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card-machine { background: white; color: #333; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .card-machine:active { transform: scale(0.96); background: #f0f0f0; }
        .icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }
        .name { font-weight: 800; color: var(--primary); text-transform: uppercase; font-size: 0.9rem; }

        /* NAVIGATION BAR */
        .nav-bar { display: none; background: white; padding: 12px; border-radius: 12px; margin-bottom: 20px; justify-content: space-between; align-items: center; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-bar.active { display: flex; }
        .nav-title { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; }
        .btn-mini { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .btn-mini:active { transform: scale(0.95); }

        /* MENU ACTIONS */
        .menu-actions { display: none; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-actions.active { display: grid; }
        .btn-menu { background: white; color: var(--primary); border: none; padding: 25px 10px; border-radius: 12px; font-weight: 800; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-menu:active { transform: scale(0.98); background: #eee; }
        .btn-rafale { grid-column: span 2; background: linear-gradient(135deg, #FFD700, #FFA500); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* SECTIONS */
        .section { display: none; background: white; color: #333; padding: 20px; border-radius: 15px; animation: slideUp 0.3s; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .section h2 { color: var(--primary); font-weight: 900; margin: 0; font-size: 1.4rem; }
        .btn-back-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d; }

        /* INPUTS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 900; font-size: 1.1rem; color: white; background: var(--primary); margin-top: 10px; cursor: pointer; transition: background 0.2s; }
        .btn-action:active { transform: scale(0.98); }
        .btn-scan { background: #28a745; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-cancel { background: #6c757d; margin-top: 10px; }
        
        /* LISTES & ETIQUETTES */
        .stock-cat { margin-bottom: 15px; background: #f9f9f9; border-radius: 8px; overflow: hidden; }
        .stock-cat-title { background: #eee; padding: 10px; font-weight: 800; color: #555; font-size: 0.9rem; text-transform: uppercase;}
        .stock-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .stock-item:last-child { border-bottom: none; }
        .badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; }
        .machine-tag { font-size: 0.7rem; background: #333; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; }

        .rafale-list { max-height: 250px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 15px 0; border: 1px solid #ddd; }
        .rafale-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; border-left: 4px solid #28a745; align-items: center; }

        /* PREVISION - TIMELINE */
        .prev-machine-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .prev-machine-name { font-weight: bold; font-size: 0.9rem; }
        .prev-date-input { padding: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.9rem; width: 140px; }
        
        .timeline { margin-top: 20px; border-left: 3px solid #ddd; padding-left: 20px; margin-left: 10px; }
        .timeline-event { position: relative; margin-bottom: 20px; }
        .timeline-event::before { content: ''; position: absolute; left: -26px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #ccc; }
        .timeline-event.danger::before { background: #dc3545; box-shadow: 0 0 5px #dc3545; }
        .timeline-event.ok::before { background: #28a745; }
        
        .timeline-date { font-weight: 800; font-size: 0.9rem; color: #555; text-transform: uppercase; margin-bottom: 5px; }
        .timeline-card { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .timeline-card.alert-card { border-left: 5px solid #dc3545; background: #fff5f5; }
        .timeline-card.ok-card { border-left: 5px solid #28a745; }

        /* MODAL */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #reader { width: 100%; max-width: 400px; background: black; border-radius: 12px; overflow: hidden; border: 3px solid white; }

        /* ALERT */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* AUTOCOMPLETE */
        .suggestions-list { background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; display: none; position: absolute; width: 100%; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:active { background: #f0f0f0; }
        .suggestions { position: relative; }
    </style>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

</head>
<body>

    <div id="scanner-modal">
        <h2 style="color:white; margin-bottom:20px;">üì∑ VISE LE CODE</h2>
        <div id="reader"></div>
        <button onclick="closeScanner()" class="btn-action" style="background:#dc3545; margin-top:20px; max-width:200px;">FERMER ‚ùå</button>
    </div>

    <div class="container">
        
        <div class="header">
            <h1>C2MI STOCK</h1>
            <p>Ma√Ætre Guigui Edition V6</p>
        </div>

        <div id="view-machines" class="grid-machines"></div>

        <div id="machine-nav" class="nav-bar">
            <span class="nav-title" id="machine-title">--</span>
            <button class="btn-mini" onclick="goHome()">üè† ACCUEIL</button>
        </div>

        <div id="view-menu" class="menu-actions">
            <button class="btn-menu" onclick="nav('stock')">üì¶ STOCK</button>
            <button class="btn-menu" onclick="nav('add')">‚ûï AJOUTER</button>
            <button class="menu-btn btn-menu" onclick="nav('remove')">‚ûñ RETIRER</button>
            <button class="btn-menu" onclick="nav('prev')">üîÆ PR√âVISION</button>
            <button class="btn-menu btn-rafale" onclick="nav('rafale')">üî´ MAGASINIER</button>
        </div>

        <div id="sec-stock" class="section">
            <div class="section-header"><h2>üì¶ Inventaire</h2><button class="btn-back-icon" onclick="goBack()">üîô</button></div>
            <div id="stock-list">Chargement...</div>
            <button class="btn-action btn-cancel" onclick="goBack()">RETOUR MENU</button>
        </div>

        <div id="sec-add" class="section">
            <div class="section-header"><h2>‚ûï Entr√©e Stock</h2><button class="btn-back-icon" onclick="goBack()">üîô</button></div>
            <button class="btn-action btn-scan" onclick="startScanner('add')">üì∑ SCANNER</button>
            <div class="form-group"><label>Code-Barres</label><input type="text" id="add_code" placeholder="Code..." oninput="checkCode(this.value)"></div>
            <div id="add_alert" class="alert alert-success" style="display:none">PRODUIT RECONNU ! ‚úÖ</div>
            <div class="form-group"><label>Cat√©gorie</label><div style="display:flex; gap:5px;"><select id="add_cat" onchange="updateTypesAdd()" style="flex:1"></select><button class="btn-mini" style="background:#28a745; width:50px; font-size:1.2rem;" onclick="newCategory()">+</button></div></div>
            <div class="form-group suggestions"><label>Type de pi√®ce</label><input type="text" id="add_type" placeholder="Ex: Filtre Huile" oninput="filterTypesAdd()" disabled><div id="add_sugg" class="suggestions-list"></div></div>
            <div class="form-group"><label>Quantit√©</label><input type="number" id="add_qty" value="1" style="text-align:center; font-size:1.5rem; font-weight:bold;"></div>
            <button id="btn-add-valid" class="btn-action" onclick="commitAdd()">VALIDER L'ENTR√âE</button>
            <button class="btn-action btn-cancel" onclick="goBack()">ANNULER</button>
        </div>

        <div id="sec-remove" class="section">
            <div class="section-header"><h2>‚ûñ Sortie Stock</h2><button class="btn-back-icon" onclick="goBack()">üîô</button></div>
            
            <button class="btn-action btn-scan" onclick="startScanner('remove')">üì∑ SCANNER SORTIE</button>
            <div style="text-align:center; margin:10px 0; font-style:italic; color:#ddd;">‚Äî OU ‚Äî</div>

            <div class="form-group">
                <label>1. Choisir Cat√©gorie</label>
                <select id="rem_cat" onchange="updateTypesRemove()">
                    <option value="">-- D'abord, choisir ici --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>2. Choisir la pi√®ce</label>
                <select id="rem_type" disabled>
                    <option value="">-- Pi√®ces disponibles --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Quantit√© (Max: <span id="rem_max">0</span>)</label>
                <input type="number" id="rem_qty" value="1">
            </div>

            <button class="btn-action" style="background:#17a2b8" onclick="manualRemoveAdd()">üëá METTRE DANS LE PANIER</button>

            <hr style="margin:20px 0; border:0; border-top:1px dashed #ccc;">
            
            <h3 style="margin-bottom:10px; color:#666; font-size:1rem;">Panier de retrait :</h3>
            <div id="rem_cart" class="rafale-list"><div style="text-align:center; color:#999; padding:20px;">Panier vide</div></div>
            
            <button class="btn-action" onclick="commitRemove()">VALIDER LA SORTIE</button>
            <button class="btn-action btn-cancel" onclick="goBack()">RETOUR MENU</button>
        </div>

        <div id="sec-rafale" class="section">
            <div class="section-header"><h2>üî´ Mode Rafale</h2><button class="btn-back-icon" onclick="goBack()">üîô</button></div>
            <button class="btn-action btn-scan" onclick="startScanner('rafale')">üöÄ D√âMARRER</button>
            <div id="rafale-list" class="rafale-list"><div style="text-align:center; padding:20px; color:#aaa;">En attente...</div></div>
            <button class="btn-action" onclick="commitRafale()">ENREGISTRER TOUT ‚úÖ</button>
            <button class="btn-action" style="background:#dc3545; margin-top:10px" onclick="clearRafale()">VIDER LA LISTE</button>
            <button class="btn-action btn-cancel" onclick="goBack()">RETOUR MENU</button>
        </div>

        <div id="sec-prev" class="section">
            <div class="section-header"><h2>üîÆ Le Visionnaire</h2><button class="btn-back-icon" onclick="goBack()">üîô</button></div>
            
            <div class="alert" style="background:#e3f2fd; color:#0d47a1; border:1px solid #bbdefb; font-size:0.9rem;">
                ‚ÑπÔ∏è Rentre la date de <strong>derni√®re maintenance</strong> (ou rentr√©e). Le syst√®me calcule +6 mois auto.
            </div>

            <div id="prev-engins-list" style="margin-bottom:20px; max-height:300px; overflow-y:auto;">
                </div>
            
            <button class="btn-action" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);" onclick="calcPrev()">üîÆ LANCER LA PROPH√âTIE</button>
            
            <div id="prev-timeline" class="timeline"></div>

            <button class="btn-action btn-cancel" onclick="goBack()">RETOUR MENU</button>
        </div>

    </div>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyDR1T9ss36NFuQWvq3ypwf7nUcqRhq5dQ8", authDomain: "maintenance-c2mi.firebaseapp.com", projectId: "maintenance-c2mi", storageBucket: "maintenance-c2mi.firebasestorage.app", messagingSenderId: "224545367081", appId: "1:224545367081:web:378d28b892528754c6a838" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DONNEES
        const DB_ENGINS = {
            "4' AXE": ["TR 020", "TR 062", "TR 083", "TR 104", "TR 111", "TR 116", "TR 127", "TR 136", "TR 141"],
            "ELAN": ["C3 N¬∞235", "ELAN D : 032"],
            "SKYRAILLER": ["C14 N¬∞32", "C14 green N¬∞83"],
            "Pelle UNAC 22 TRR": ["N¬∞ 051", "N¬∞ 086", "N¬∞ 088"],
            "Debroussailleuse R/R": ["300RR N¬∞23", "300RR N¬∞24", "N¬∞ 27", "N¬∞ 30"],
            "ACX": ["ACX 01", "ACX 02"]
        };

        // AJOUT DU PREFILTRE DANS LES BASIQUES
        let CATEGORIES = {
            'filtration': { name: 'Filtration', types: ['Filtre Huile', 'Filtre Gasoil', 'Pr√©filtre', 'Filtre Air'] },
            'freinage': { name: 'Freinage', types: ['Plaquettes', 'Disques'] }
        };

        let currentMachine = "";
        let stockData = {};
        let maintenanceDates = {}; // Pour stocker les dates
        let scanner = null;
        let scanMode = ""; 
        let rafaleBuffer = [];
        let removeBuffer = [];
        let unsubscribe = null;

        // INIT
        window.onload = function() {
            renderMachines();
            loadCategories();
        };

        function renderMachines() {
            const grid = document.getElementById('view-machines');
            grid.innerHTML = "";
            const icons = { "4' AXE": "üöÇ", "ELAN": "üöÖ", "SKYRAILLER": "üöÑ", "Pelle UNAC 22 TRR": "üèóÔ∏è", "Debroussailleuse R/R": "üåø", "ACX": "üöÜ" };
            
            for(let key in DB_ENGINS) {
                const safeKey = key.replace(/'/g, "\\'");
                grid.innerHTML += `
                    <div class="card-machine" onclick="selectMachine('${safeKey}')">
                        <span class="icon">${icons[key] || 'üöú'}</span>
                        <span class="name">${key}</span>
                    </div>
                `;
            }
        }

        function loadCategories() {
            db.collection("config").doc("categories_stock").get().then((doc) => {
                if (doc.exists) CATEGORIES = doc.data();
                else db.collection("config").doc("categories_stock").set(CATEGORIES);
                updateSelectsAdd();
            }).catch(() => updateSelectsAdd());
        }

        function updateSelectsAdd() {
            const el = document.getElementById('add_cat');
            if(!el) return;
            el.innerHTML = '<option value="">-- Cat√©gorie --</option>';
            for(let k in CATEGORIES) {
                el.innerHTML += `<option value="${k}">${CATEGORIES[k].name}</option>`;
            }
        }

        // NAVIGATION & ISOLATION
        function selectMachine(key) {
            currentMachine = key;
            stockData = {};
            maintenanceDates = {}; // Reset dates
            
            document.getElementById('view-machines').style.display = 'none';
            document.getElementById('machine-nav').classList.add('active');
            document.getElementById('machine-title').innerText = key;
            document.getElementById('view-menu').classList.add('active');

            if(unsubscribe) unsubscribe();
            // Charger Stock
            unsubscribe = db.collection("stocks").doc(currentMachine).onSnapshot((doc) => {
                stockData = doc.exists ? doc.data() : {};
                if(document.getElementById('sec-stock').classList.contains('active')) renderStock();
                if(document.getElementById('sec-remove').classList.contains('active')) initRemoveSelects();
            });

            // Charger Dates Maintenance
            db.collection("maintenance").doc(currentMachine).get().then(doc => {
                if(doc.exists) maintenanceDates = doc.data();
            });
        }

        function goHome() {
            if(unsubscribe) unsubscribe();
            currentMachine = "";
            stockData = {}; 
            document.getElementById('view-machines').style.display = 'grid';
            document.getElementById('machine-nav').classList.remove('active');
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
        }

        function nav(section) {
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
            document.getElementById(`sec-${section}`).classList.add('active');
            
            if(section === 'stock') renderStock();
            if(section === 'prev') renderPrevList();
            if(section === 'add') updateSelectsAdd();
            if(section === 'remove') initRemoveSelects();
        }

        function goBack() {
            hideAllSections();
            document.getElementById('view-menu').classList.add('active');
        }

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        }

        // --- AFFICHAGE STOCK ---
        function renderStock() {
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            
            if (!stockData || Object.keys(stockData).length === 0) {
                 list.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>Stock vide pour " + currentMachine + ".</div>";
                 return;
            }

            let somethingDisplayed = false;
            for(let catKey in stockData) {
                const catContent = stockData[catKey];
                if (typeof catContent === 'object' && catContent !== null) {
                    const types = Object.keys(catContent);
                    const activeTypes = types.filter(t => Array.isArray(catContent[t]) && catContent[t].length > 0);

                    if(activeTypes.length > 0) {
                        somethingDisplayed = true;
                        const prettyName = (CATEGORIES[catKey] && CATEGORIES[catKey].name) ? CATEGORIES[catKey].name : catKey.toUpperCase();
                        
                        let html = `<div class="stock-cat"><div class="stock-cat-title">${prettyName}</div>`;
                        activeTypes.forEach(t => {
                            html += `
                                <div class="stock-item">
                                    <div>
                                        <span>${t}</span>
                                        <span class="machine-tag">${currentMachine}</span>
                                    </div>
                                    <span class="badge">${catContent[t].length}</span>
                                </div>`;
                        });
                        html += `</div>`;
                        list.innerHTML += html;
                    }
                }
            }
            if(!somethingDisplayed) list.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>Stock vide.</div>";
        }

        // --- AJOUT ---
        function newCategory() {
            const nom = prompt("Nom de la cat√©gorie ?");
            if(!nom) return;
            const id = nom.toLowerCase().trim().replace(/\s+/g, '_');
            CATEGORIES[id] = { name: nom, types: [] };
            db.collection("config").doc("categories_stock").set(CATEGORIES, {merge: true})
                .then(() => { 
                    alert("‚úÖ Cat√©gorie cr√©√©e !"); 
                    updateSelectsAdd(); 
                    setTimeout(() => document.getElementById('add_cat').value = id, 100);
                });
        }

        function updateTypesAdd() {
            const cat = document.getElementById(`add_cat`).value;
            const inp = document.getElementById(`add_type`);
            inp.disabled = !cat;
            inp.value = "";
        }

        function filterTypesAdd() {
            const cat = document.getElementById(`add_cat`).value;
            const inp = document.getElementById(`add_type`);
            const sugg = document.getElementById(`add_sugg`);
            const val = inp.value.toLowerCase();
            
            if(!cat) return;
            const types = CATEGORIES[cat]?.types || []; 
            const matches = types.filter(t => t.toLowerCase().includes(val));

            sugg.innerHTML = "";
            sugg.style.display = 'block';

            matches.forEach(t => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = t;
                div.onclick = () => { inp.value = t; sugg.style.display = 'none'; };
                sugg.appendChild(div);
            });

            if(val && !matches.includes(inp.value)) {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>+ Cr√©er type "${inp.value}"</strong>`;
                div.onclick = () => {
                    if(CATEGORIES[cat] && !CATEGORIES[cat].types.includes(inp.value)) {
                        CATEGORIES[cat].types.push(inp.value);
                        db.collection("config").doc("categories_stock").set(CATEGORIES, {merge: true});
                    }
                    sugg.style.display = 'none';
                };
                sugg.appendChild(div);
            }
            setTimeout(() => document.addEventListener('click', e => { if(e.target !== inp) sugg.style.display = 'none'; }, {once:true}), 100);
        }

        function commitAdd() {
            const cat = document.getElementById('add_cat').value;
            const type = document.getElementById('add_type').value;
            const qty = parseInt(document.getElementById('add_qty').value);
            const code = document.getElementById('add_code').value;

            if(!cat || !type || !qty) return alert("Remplis tout !");

            const items = [];
            for(let i=0; i<qty; i++) items.push({code: code, date: new Date().toISOString()});

            const updateData = {};
            updateData[cat] = {}; 
            updateData[cat][type] = firebase.firestore.FieldValue.arrayUnion(...items);

            db.collection("stocks").doc(currentMachine).set(updateData, {merge: true})
                .then(() => {
                    alert("‚úÖ Ajout√© dans " + currentMachine + " !");
                    document.getElementById('add_code').value = "";
                    document.getElementById('add_alert').style.display = 'none';
                    document.getElementById('add_qty').value = 1;
                    document.getElementById('add_cat').value = "";
                    document.getElementById('add_type').value = "";
                    document.getElementById('add_type').disabled = true;
                })
                .catch(e => alert("Erreur: " + e.message));
        }

        // --- RETRAIT ---
        function initRemoveSelects() {
            const catSelect = document.getElementById('rem_cat');
            catSelect.innerHTML = '<option value="">-- Choisir Cat√©gorie --</option>';
            document.getElementById('rem_type').innerHTML = '<option value="">-- D\'abord la cat√©gorie --</option>';
            document.getElementById('rem_type').disabled = true;

            if (!stockData) return;

            for(let cat in stockData) {
                if (typeof stockData[cat] === 'object' && stockData[cat] !== null) {
                    const hasItems = Object.keys(stockData[cat]).some(type => stockData[cat][type].length > 0);
                    if (hasItems) {
                        const name = CATEGORIES[cat] ? CATEGORIES[cat].name : cat;
                        catSelect.innerHTML += `<option value="${cat}">${name}</option>`;
                    }
                }
            }
        }

        function updateTypesRemove() {
            const cat = document.getElementById('rem_cat').value;
            const typeSelect = document.getElementById('rem_type');
            
            typeSelect.innerHTML = '<option value="">-- Choisir la pi√®ce --</option>';
            typeSelect.disabled = !cat;
            document.getElementById('rem_max').innerText = "0";

            if(!cat || !stockData[cat]) return;

            for(let type in stockData[cat]) {
                const count = stockData[cat][type].length;
                if(count > 0) {
                    typeSelect.innerHTML += `<option value="${type}">${type} (Dispo: ${count})</option>`;
                }
            }
            
            typeSelect.onchange = function() {
                const t = this.value;
                if(t && stockData[cat][t]) document.getElementById('rem_max').innerText = stockData[cat][t].length;
            };
        }

        function manualRemoveAdd() {
            const cat = document.getElementById('rem_cat').value;
            const type = document.getElementById('rem_type').value;
            const qty = parseInt(document.getElementById('rem_qty').value);
            
            if(!cat || !type) return alert("Choisis une pi√®ce !");
            const dispo = stockData[cat][type].length;
            if (qty > dispo) return alert("Pas assez de stock ! Max: " + dispo);

            addToRemoveCart(cat, type, qty);
            document.getElementById('rem_cat').value = "";
            updateTypesRemove();
            document.getElementById('rem_qty').value = "1";
        }

        function checkCode(code) {
            if (!stockData) return;
            for(let c in stockData) {
                if(typeof stockData[c] !== 'object') continue;
                for(let t in stockData[c]) {
                    if(Array.isArray(stockData[c][t]) && stockData[c][t].some(i => i.code === code)) {
                        document.getElementById('add_alert').style.display = 'block';
                        if(document.querySelector(`#add_cat option[value="${c}"]`)) document.getElementById('add_cat').value = c;
                        updateTypesAdd();
                        setTimeout(() => document.getElementById('add_type').value = t, 50);
                        return;
                    }
                }
            }
            document.getElementById('add_alert').style.display = 'none';
        }

        function startScanner(mode) {
            scanMode = mode;
            document.getElementById('scanner-modal').style.display = 'flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                onScanSuccess
            ).catch(err => alert("Erreur Cam: " + err));
        }

        function closeScanner() {
            if(scanner) scanner.stop().then(() => { scanner.clear(); document.getElementById('scanner-modal').style.display = 'none'; });
            else document.getElementById('scanner-modal').style.display = 'none';
        }

        function onScanSuccess(code) {
            if(scanMode === 'add') {
                document.getElementById('add_code').value = code;
                checkCode(code);
                closeScanner();
            } else if (scanMode === 'rafale') {
                handleRafale(code);
                scanner.pause();
                setTimeout(() => scanner.resume(), 1500);
            } else if(scanMode === 'remove') {
                closeScanner();
                checkCodeRemove(code);
            }
        }

        function checkCodeRemove(code) {
             let found = null;
            try {
                for(let c in stockData) {
                    if(typeof stockData[c] !== 'object') continue;
                    for(let t in stockData[c]) {
                        if(Array.isArray(stockData[c][t]) && stockData[c][t].some(i => i.code === code)) {
                            found = {cat:c, type:t};
                            break;
                        }
                    }
                    if(found) break;
                }
            } catch(e) { console.error(e); }

            if(found) addToRemoveCart(found.cat, found.type, 1);
            else alert("Code inconnu pour " + currentMachine);
        }

        function addToRemoveCart(cat, type, qty) {
            const dispo = stockData[cat]?.[type]?.length || 0;
            const inCart = removeBuffer.find(i => i.cat === cat && i.type === type)?.qty || 0;
            if(dispo < (qty + inCart)) return alert(`Pas assez de stock (${dispo})`);
            
            const ex = removeBuffer.find(i => i.cat === cat && i.type === type);
            if(ex) ex.qty += qty;
            else removeBuffer.push({cat, type, qty});
            renderRemoveCart();
        }

        function renderRemoveCart() {
            const d = document.getElementById('rem_cart');
            d.innerHTML = removeBuffer.length ? "" : "Vide";
            removeBuffer.forEach((i, idx) => {
                d.innerHTML += `
                    <div class="rafale-item">
                        <span>${i.qty}x ${i.type}</span>
                        <button style="background:red;border:none;color:white;padding:5px 10px;border-radius:5px;" onclick="delRem(${idx})">X</button>
                    </div>
                `;
            });
        }
        function delRem(i) { removeBuffer.splice(i, 1); renderRemoveCart(); }

        function commitRemove() {
            if(!removeBuffer.length) return;
            const docRef = db.collection("stocks").doc(currentMachine);
            db.runTransaction(async (t) => {
                const doc = await t.get(docRef);
                const data = doc.data();
                removeBuffer.forEach(item => {
                    if (data[item.cat] && data[item.cat][item.type]) {
                        const list = data[item.cat][item.type];
                        if(list.length >= item.qty) {
                            list.splice(-item.qty);
                            data[item.cat][item.type] = list;
                        }
                    }
                });
                t.update(docRef, data);
            }).then(() => {
                alert("‚úÖ Retir√© du stock " + currentMachine + " !");
                removeBuffer = [];
                renderRemoveCart();
                initRemoveSelects();
            }).catch(e => alert("Erreur: " + e));
        }

        function handleRafale(code) {
            let found = null;
            if (stockData) {
                for(let c in stockData) {
                    if(typeof stockData[c] !== 'object') continue;
                    for(let t in stockData[c]) {
                        if(Array.isArray(stockData[c][t]) && stockData[c][t].some(i => i.code === code)) found = {cat:c, type:t};
                    }
                }
            }
            if(found) {
                rafaleBuffer.push({...found, code, qty:1});
                renderRafale();
            } else {
                closeScanner();
                const t = prompt("Inconnu ! Nom ?");
                if(t) {
                    rafaleBuffer.push({cat:'filtration', type:t, code, qty:1});
                    startScanner('rafale');
                }
            }
        }

        function renderRafale() {
            const d = document.getElementById('rafale-list');
            d.innerHTML = "";
            rafaleBuffer.forEach(i => d.innerHTML += `<div class="rafale-item"><span>${i.type}</span><span>üì¶</span></div>`);
        }
        function clearRafale() { rafaleBuffer = []; renderRafale(); }

        function commitRafale() {
            if(!rafaleBuffer.length) return;
            const docRef = db.collection("stocks").doc(currentMachine);
            
            docRef.get().then(doc => {
                let data = doc.exists ? doc.data() : {};
                rafaleBuffer.forEach(item => {
                    if(!data[item.cat]) data[item.cat] = {};
                    if(!data[item.cat][item.type]) data[item.cat][item.type] = [];
                    data[item.cat][item.type].push({code: item.code, date: new Date().toISOString()});
                    
                    if(CATEGORIES[item.cat] && !CATEGORIES[item.cat].types.includes(item.type)) {
                        CATEGORIES[item.cat].types.push(item.type);
                        db.collection("config").doc("categories_stock").set(CATEGORIES, {merge:true});
                    }
                });
                docRef.set(data, {merge:true}).then(() => {
                    alert("‚úÖ Tout enregistr√© dans " + currentMachine + " !");
                    clearRafale();
                });
            });
        }

        // --- NOUVELLE LOGIQUE PREVISION (TIMELINE) ---
        function renderPrevList() {
            const d = document.getElementById('prev-engins-list');
            d.innerHTML = "";
            const engins = DB_ENGINS[currentMachine] || [];
            
            engins.forEach((name, i) => {
                // On r√©cup√®re la date enregistr√©e ou vide
                const savedDate = maintenanceDates[name] || "";
                
                d.innerHTML += `
                    <div class="prev-machine-row">
                        <span class="prev-machine-name">${name}</span>
                        <input type="date" class="prev-date-input" id="date_${i}" value="${savedDate}" onchange="saveDate('${name}', this.value)">
                    </div>
                `;
            });
        }

        function saveDate(machineName, dateVal) {
            maintenanceDates[machineName] = dateVal;
            // On sauvegarde direct dans Firebase pour pas perdre
            db.collection("maintenance").doc(currentMachine).set(maintenanceDates, {merge:true});
        }

        function calcPrev() {
            const timelineDiv = document.getElementById('prev-timeline');
            timelineDiv.innerHTML = "";

            // 1. R√©cup√©rer les Stocks Actuels
            // On cherche "Filtre Huile", "Filtre Gasoil", "Pr√©filtre", "Filtre Air" dans la cat "filtration"
            // Note: Si l'utilisateur les a nomm√©s autrement, il faudra adapter. On suppose les noms standards.
            let stocks = {
                'Huile': stockData['filtration']?.['Filtre Huile']?.length || 0,
                'Gasoil': stockData['filtration']?.['Filtre Gasoil']?.length || 0,
                'Air': stockData['filtration']?.['Filtre Air']?.length || 0,
                'Pr√©filtre': stockData['filtration']?.['Pr√©filtre']?.length || 0
            };

            // 2. Calculer les √©v√©nements sur 12 mois
            const events = [];
            const engins = DB_ENGINS[currentMachine] || [];
            
            engins.forEach(name => {
                const dateStr = maintenanceDates[name];
                if(dateStr) {
                    const lastMaint = new Date(dateStr);
                    // R√®gle des 6 mois
                    const nextMaint = new Date(lastMaint);
                    nextMaint.setMonth(nextMaint.getMonth() + 6);
                    
                    // Si la date est dans le futur (ou tr√®s proche pass√©)
                    events.push({ 
                        date: nextMaint, 
                        machine: name, 
                        type: 'maintenance' 
                    });
                }
            });

            // Trier par date
            events.sort((a, b) => a.date - b.date);

            // 3. G√©n√©rer la Timeline
            if(events.length === 0) {
                timelineDiv.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Aucune date de maintenance renseign√©e.</div>";
                return;
            }

            // Mois en fran√ßais
            const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

            events.forEach(evt => {
                // Consommer le stock virtuel
                stocks['Huile']--;
                stocks['Gasoil']--;
                stocks['Air']--;
                stocks['Pr√©filtre']--;

                // V√©rifier si rupture
                const missing = [];
                if(stocks['Huile'] < 0) missing.push("Huile");
                if(stocks['Gasoil'] < 0) missing.push("Gasoil");
                if(stocks['Air'] < 0) missing.push("Air");
                if(stocks['Pr√©filtre'] < 0) missing.push("Pr√©filtre");

                const isDanger = missing.length > 0;
                const datePretty = `${months[evt.date.getMonth()]} ${evt.date.getFullYear()}`;
                
                let html = `
                    <div class="timeline-event ${isDanger ? 'danger' : 'ok'}">
                        <div class="timeline-date">${datePretty}</div>
                        <div class="timeline-card ${isDanger ? 'alert-card' : 'ok-card'}">
                            <strong>${evt.machine}</strong> arrive √† l'atelier.
                            <br>
                `;

                if(isDanger) {
                    html += `<span style="color:#dc3545; font-weight:bold;">‚ö†Ô∏è STOCK INSUFFISANT !</span><br>Manque : ${missing.join(', ')}`;
                } else {
                    html += `<span style="color:#28a745; font-weight:bold;">‚úÖ Stock OK</span>`;
                }

                html += `</div></div>`;
                timelineDiv.innerHTML += html;
            });
        }
    </script>
</body>
</html>
