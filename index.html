<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2MI STOCK - TERMINATOR</title>
    
    <!-- 1. STYLE (CSS) -->
    <style>
        :root { --primary: #E30066; --bg: #f4f4f9; --text: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--primary); color: white; padding-bottom: 100px; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }

        /* HEADER */
        .header { background: white; color: var(--primary); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .header h1 { font-weight: 900; font-size: 1.8rem; text-transform: uppercase; }

        /* MACHINES */
        .grid-machines { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card-machine { background: white; color: #333; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .card-machine:active { transform: scale(0.96); }
        .icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }
        .name { font-weight: 800; color: var(--primary); text-transform: uppercase; font-size: 0.9rem; }

        /* NAVIGATION */
        .nav-bar { display: none; background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; justify-content: space-between; align-items: center; color: var(--primary); }
        .nav-bar.active { display: flex; }
        .nav-title { font-weight: 900; font-size: 1.2rem; }
        .btn-mini { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* MENU */
        .menu-actions { display: none; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-actions.active { display: grid; }
        .btn-menu { background: white; color: var(--primary); border: none; padding: 25px 10px; border-radius: 12px; font-weight: 800; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-menu:active { transform: scale(0.98); background: #eee; }
        .btn-rafale { grid-column: span 2; background: linear-gradient(135deg, #FFD700, #FFA500); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* SECTIONS */
        .section { display: none; background: white; color: #333; padding: 20px; border-radius: 15px; animation: slideUp 0.3s; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .section h2 { color: var(--primary); font-weight: 900; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        /* INPUTS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }
        
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 900; font-size: 1.1rem; color: white; background: var(--primary); margin-top: 10px; cursor: pointer; }
        .btn-scan { background: #28a745; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* LISTES */
        .stock-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; }
        .rafale-list { max-height: 250px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 15px 0; border: 1px solid #ddd; }
        .rafale-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; border-left: 4px solid #28a745; }

        /* MODAL */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #reader { width: 100%; max-width: 400px; background: black; border-radius: 12px; overflow: hidden; border: 3px solid white; }

        /* ALERT */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        
        /* AUTOCOMPLETE */
        .suggestions-list { background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; display: none; position: absolute; width: 100%; z-index: 100; }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestions { position: relative; }
    </style>

    <!-- 2. LIBRAIRIES ROBUSTES (COMPATIBILITE MAXIMALE) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

</head>
<body>

    <!-- SCANNER MODAL -->
    <div id="scanner-modal">
        <h2 style="color:white; margin-bottom:20px;">üì∑ VISE LE CODE</h2>
        <div id="reader"></div>
        <button onclick="closeScanner()" class="btn-action" style="background:#dc3545; margin-top:20px; max-width:200px;">FERMER</button>
    </div>

    <div class="container">
        
        <div class="header">
            <h1>C2MI STOCK</h1>
            <p>Ma√Ætre Guigui Edition</p>
        </div>

        <!-- 1. ACCUEIL MACHINES -->
        <div id="view-machines" class="grid-machines">
            <!-- JS va remplir √ßa -->
        </div>

        <!-- BARRE NAVIGATION -->
        <div id="machine-nav" class="nav-bar">
            <span class="nav-title" id="machine-title">--</span>
            <button class="btn-mini" onclick="goHome()">Changer</button>
        </div>

        <!-- 2. MENU ACTIONS -->
        <div id="view-menu" class="menu-actions">
            <button class="btn-menu" onclick="nav('stock')">üì¶ STOCK</button>
            <button class="btn-menu" onclick="nav('add')">‚ûï AJOUTER</button>
            <button class="menu-btn btn-menu" onclick="nav('remove')">‚ûñ RETIRER</button>
            <button class="btn-menu" onclick="nav('prev')">üìä PR√âVISION</button>
            <button class="btn-menu btn-rafale" onclick="nav('rafale')">üî´ MAGASINIER</button>
        </div>

        <!-- 3. SECTIONS -->

        <!-- STOCK -->
        <div id="sec-stock" class="section">
            <h2>üì¶ Inventaire</h2>
            <div id="stock-list">Chargement...</div>
            <button class="btn-action" style="background:#6c757d" onclick="goBack()">Retour Menu</button>
        </div>

        <!-- AJOUTER -->
        <div id="sec-add" class="section">
            <h2>‚ûï Entr√©e Stock</h2>
            <button class="btn-action btn-scan" onclick="startScanner('add')">üì∑ SCANNER</button>
            
            <div class="form-group">
                <label>Code-Barres</label>
                <input type="text" id="add_code" placeholder="Code..." oninput="checkCode(this.value)">
            </div>
            
            <div id="add_alert" class="alert alert-success" style="display:none">PRODUIT RECONNU ! ‚úÖ</div>

            <div class="form-group">
                <label>Cat√©gorie</label>
                <div style="display:flex; gap:5px;">
                    <select id="add_cat" onchange="updateTypes('add')" style="flex:1"></select>
                    <button class="btn-mini" style="background:#28a745; width:50px; font-size:1.2rem;" onclick="newCategory()">+</button>
                </div>
            </div>

            <div class="form-group suggestions">
                <label>Type de pi√®ce</label>
                <input type="text" id="add_type" placeholder="Ex: Filtre Huile" oninput="filterTypes('add')" disabled>
                <div id="add_sugg" class="suggestions-list"></div>
            </div>

            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="add_qty" value="1" style="text-align:center; font-size:1.5rem; font-weight:bold;">
            </div>

            <button id="btn-add-valid" class="btn-action" onclick="commitAdd()">VALIDER L'ENTR√âE</button>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="goBack()">Annuler</button>
        </div>

        <!-- RETIRER -->
        <div id="sec-remove" class="section">
            <h2>‚ûñ Sortie Stock</h2>
            <button class="btn-action btn-scan" onclick="startScanner('remove')">üì∑ SCANNER SORTIE</button>
            <div class="form-group"><label>Code (si manuel)</label><input type="text" id="rem_code" oninput="checkCodeRemove(this.value)"></div>
            <div id="rem_cart" class="rafale-list"><div style="text-align:center; color:#999; padding:20px;">Panier vide</div></div>
            <button class="btn-action" onclick="commitRemove()">VALIDER SORTIE</button>
            <hr style="margin:20px 0;">
            <h3>Manuel</h3>
            <div class="form-group"><select id="rem_cat" onchange="updateTypes('rem')"></select></div>
            <div class="form-group suggestions"><input type="text" id="rem_type" disabled oninput="filterTypes('rem')"><div id="rem_sugg" class="suggestions-list"></div></div>
            <div class="form-group"><input type="number" id="rem_qty" value="1"></div>
            <button class="btn-action" style="background:#17a2b8" onclick="manualRemoveAdd()">Ajouter</button>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="goBack()">Retour</button>
        </div>

        <!-- RAFALE -->
        <div id="sec-rafale" class="section">
            <h2>üî´ Mode Rafale</h2>
            <button class="btn-action btn-scan" onclick="startScanner('rafale')">üöÄ D√âMARRER</button>
            <div id="rafale-list" class="rafale-list"><div style="text-align:center; padding:20px; color:#aaa;">En attente...</div></div>
            <button class="btn-action" onclick="commitRafale()">ENREGISTRER TOUT ‚úÖ</button>
            <button class="btn-action" style="background:#dc3545; margin-top:10px" onclick="clearRafale()">Vider</button>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="goBack()">Retour</button>
        </div>

        <!-- PREVISION -->
        <div id="sec-prev" class="section">
            <h2>üìä Pr√©visions</h2>
            <div id="prev-engins-list" style="margin-bottom:20px"></div>
            <button class="btn-action" onclick="calcPrev()">CALCULER</button>
            <div id="prev-res" style="margin-top:20px"></div>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="goBack()">Retour</button>
        </div>

    </div>

    <!-- 3. SCRIPT PRINCIPAL (CLASSIQUE, PAS DE MODULE) -->
    <script>
        // CONFIG FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyDR1T9ss36NFuQWvq3ypwf7nUcqRhq5dQ8", authDomain: "maintenance-c2mi.firebaseapp.com", projectId: "maintenance-c2mi", storageBucket: "maintenance-c2mi.firebasestorage.app", messagingSenderId: "224545367081", appId: "1:224545367081:web:378d28b892528754c6a838" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DONNEES
        const DB_ENGINS = {
            "4' AXE": ["TR 020", "TR 062", "TR 083", "TR 104", "TR 111", "TR 116", "TR 127", "TR 136", "TR 141"],
            "ELAN": ["C3 N¬∞235", "ELAN D : 032"],
            "SKYRAILLER": ["C14 N¬∞32", "C14 green N¬∞83"],
            "Pelle UNAC 22 TRR": ["N¬∞ 051", "N¬∞ 086", "N¬∞ 088"],
            "Debroussailleuse R/R": ["300RR N¬∞23", "300RR N¬∞24", "N¬∞ 27", "N¬∞ 30"],
            "ACX": ["ACX 01", "ACX 02"]
        };

        let CATEGORIES = {
            'filtration': { name: 'Filtration', types: ['Filtre Huile', 'Filtre Gasoil', 'Filtre Air'] },
            'freinage': { name: 'Freinage', types: ['Plaquettes', 'Disques'] }
        };

        let currentMachine = "";
        let stockData = {};
        let scanner = null;
        let scanMode = ""; 
        let rafaleBuffer = [];
        let removeBuffer = [];
        let unsubscribe = null;

        // INIT
        window.onload = function() {
            renderMachines();
            loadCategories();
        };

        function renderMachines() {
            const grid = document.getElementById('view-machines');
            grid.innerHTML = "";
            const icons = { "4' AXE": "üöÇ", "ELAN": "üöÖ", "SKYRAILLER": "üöÑ", "Pelle UNAC 22 TRR": "üèóÔ∏è", "Debroussailleuse R/R": "üåø", "ACX": "üöÜ" };
            
            for(let key in DB_ENGINS) {
                // LA CORRECTION FATALE EST ICI : .replace(/'/g, "\\'")
                // On √©chappe l'apostrophe pour que le JS ne plante pas
                const safeKey = key.replace(/'/g, "\\'");
                grid.innerHTML += `
                    <div class="card-machine" onclick="selectMachine('${safeKey}')">
                        <span class="icon">${icons[key] || 'üöú'}</span>
                        <span class="name">${key}</span>
                    </div>
                `;
            }
        }

        function loadCategories() {
            db.collection("config").doc("categories_stock").get().then((doc) => {
                if (doc.exists) CATEGORIES = doc.data();
                else db.collection("config").doc("categories_stock").set(CATEGORIES);
                updateSelects();
            }).catch((error) => {
                console.log("Erreur chargement cat, utilisation defaut", error);
                updateSelects();
            });
        }

        function updateSelects() {
            const ids = ['add_cat', 'rem_cat'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = '<option value="">-- Cat√©gorie --</option>';
                for(let k in CATEGORIES) {
                    el.innerHTML += `<option value="${k}">${CATEGORIES[k].name}</option>`;
                }
            });
        }

        // NAVIGATION
        function selectMachine(key) {
            currentMachine = key;
            document.getElementById('view-machines').style.display = 'none';
            document.getElementById('machine-nav').classList.add('active');
            document.getElementById('machine-title').innerText = key;
            document.getElementById('view-menu').classList.add('active');

            if(unsubscribe) unsubscribe();
            unsubscribe = db.collection("stocks").doc(currentMachine).onSnapshot((doc) => {
                stockData = doc.exists ? doc.data() : {};
                if(document.getElementById('sec-stock').classList.contains('active')) renderStock();
            });
        }

        function goHome() {
            if(unsubscribe) unsubscribe();
            currentMachine = "";
            document.getElementById('view-machines').style.display = 'grid';
            document.getElementById('machine-nav').classList.remove('active');
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
        }

        function nav(section) {
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
            document.getElementById(`sec-${section}`).classList.add('active');
            if(section === 'stock') renderStock();
            if(section === 'prev') renderPrevList();
            if(section === 'add' || section === 'remove') updateSelects();
        }

        function goBack() {
            hideAllSections();
            document.getElementById('view-menu').classList.add('active');
        }

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        }

        // NOUVELLE CATEGORIE
        function newCategory() {
            const nom = prompt("Nom de la cat√©gorie ?");
            if(!nom) return;
            const id = nom.toLowerCase().replace(/\s/g, '_');
            if(CATEGORIES[id]) return alert("Existe d√©j√† !");
            
            CATEGORIES[id] = { name: nom, types: [] };
            db.collection("config").doc("categories_stock").set(CATEGORIES, {merge: true})
                .then(() => { alert("‚úÖ Cr√©√© !"); updateSelects(); });
        }

        // STOCK DISPLAY
        function renderStock() {
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            let empty = true;

            for(let catKey in CATEGORIES) {
                const catStock = stockData[catKey] || {};
                const types = Object.keys(catStock);
                const activeTypes = types.filter(t => Array.isArray(catStock[t]) && catStock[t].length > 0);

                if(activeTypes.length > 0) {
                    empty = false;
                    let html = `<div style="margin-bottom:15px;"><div style="background:#eee; padding:8px; font-weight:bold; color:#555; border-radius:5px;">${CATEGORIES[catKey].name}</div>`;
                    activeTypes.forEach(t => {
                        html += `<div class="stock-item"><span>${t}</span><span class="badge" style="background:#E30066; color:white; padding:2px 8px; border-radius:10px;">${catStock[t].length}</span></div>`;
                    });
                    html += `</div>`;
                    list.innerHTML += html;
                }
            }
            if(empty) list.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>Vide</div>";
        }

        // AJOUT
        function updateTypes(prefix) {
            const cat = document.getElementById(`${prefix}_cat`).value;
            const inp = document.getElementById(`${prefix}_type`);
            inp.disabled = !cat;
            inp.value = "";
        }

        function filterTypes(prefix) {
            const cat = document.getElementById(`${prefix}_cat`).value;
            const inp = document.getElementById(`${prefix}_type`);
            const sugg = document.getElementById(`${prefix}_sugg`);
            const val = inp.value.toLowerCase();
            
            if(!cat) return;
            const types = CATEGORIES[cat].types || [];
            const matches = types.filter(t => t.toLowerCase().includes(val));

            sugg.innerHTML = "";
            sugg.style.display = 'block';

            matches.forEach(t => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = t;
                div.onclick = () => { inp.value = t; sugg.style.display = 'none'; };
                sugg.appendChild(div);
            });

            if(val && !matches.includes(inp.value)) {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>+ Cr√©er "${inp.value}"</strong>`;
                div.onclick = () => {
                    if(!CATEGORIES[cat].types.includes(inp.value)) {
                        CATEGORIES[cat].types.push(inp.value);
                        db.collection("config").doc("categories_stock").set(CATEGORIES, {merge: true});
                    }
                    sugg.style.display = 'none';
                };
                sugg.appendChild(div);
            }
            // Close onclick outside
            setTimeout(() => document.addEventListener('click', e => { if(e.target !== inp) sugg.style.display = 'none'; }, {once:true}), 100);
        }

        function checkCode(code) {
            for(let c in stockData) {
                for(let t in stockData[c]) {
                    if(stockData[c][t].some(i => i.code === code)) {
                        document.getElementById('add_alert').style.display = 'block';
                        document.getElementById('add_cat').value = c;
                        updateTypes('add');
                        setTimeout(() => document.getElementById('add_type').value = t, 50);
                        return;
                    }
                }
            }
            document.getElementById('add_alert').style.display = 'none';
        }

        function commitAdd() {
            const cat = document.getElementById('add_cat').value;
            const type = document.getElementById('add_type').value;
            const qty = parseInt(document.getElementById('add_qty').value);
            const code = document.getElementById('add_code').value;

            if(!cat || !type || !qty) return alert("Remplis tout !");

            const items = [];
            for(let i=0; i<qty; i++) items.push({code: code, date: new Date().toISOString()});

            const updateData = {};
            // Firestore arrayUnion pour ajout sans ecraser
            updateData[`${cat}.${type}`] = firebase.firestore.FieldValue.arrayUnion(...items);

            db.collection("stocks").doc(currentMachine).set(updateData, {merge: true})
                .then(() => {
                    alert("‚úÖ Ajout√© !");
                    document.getElementById('add_code').value = "";
                    document.getElementById('add_alert').style.display = 'none';
                    document.getElementById('add_qty').value = 1;
                })
                .catch(e => alert("Erreur: " + e.message));
        }

        // SCANNER
        function startScanner(mode) {
            scanMode = mode;
            document.getElementById('scanner-modal').style.display = 'flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                onScanSuccess
            ).catch(err => alert("Erreur Cam: " + err));
        }

        function closeScanner() {
            if(scanner) scanner.stop().then(() => { scanner.clear(); document.getElementById('scanner-modal').style.display = 'none'; });
            else document.getElementById('scanner-modal').style.display = 'none';
        }

        function onScanSuccess(code) {
            if(scanMode === 'add') {
                document.getElementById('add_code').value = code;
                checkCode(code);
                closeScanner();
            } else if (scanMode === 'rafale') {
                handleRafale(code);
                scanner.pause();
                setTimeout(() => scanner.resume(), 1500);
            } else if(scanMode === 'remove') {
                document.getElementById('rem_code').value = code;
                checkCodeRemove(code);
                closeScanner();
            }
        }

        // RETRAIT
        function checkCodeRemove(code) {
            let found = null;
            for(let c in stockData) {
                for(let t in stockData[c]) {
                    if(stockData[c][t].some(i => i.code === code)) found = {cat:c, type:t};
                }
            }
            if(found) addToRemoveCart(found.cat, found.type, 1);
            else alert("Inconnu dans ce stock.");
        }

        function manualRemoveAdd() {
            const cat = document.getElementById('rem_cat').value;
            const type = document.getElementById('rem_type').value;
            const qty = parseInt(document.getElementById('rem_qty').value);
            if(cat && type) addToRemoveCart(cat, type, qty);
        }

        function addToRemoveCart(cat, type, qty) {
            const dispo = stockData[cat]?.[type]?.length || 0;
            const inCart = removeBuffer.find(i => i.cat === cat && i.type === type)?.qty || 0;
            if(dispo < (qty + inCart)) return alert(`Pas assez de stock (${dispo})`);
            
            const ex = removeBuffer.find(i => i.cat === cat && i.type === type);
            if(ex) ex.qty += qty;
            else removeBuffer.push({cat, type, qty});
            renderRemoveCart();
        }

        function renderRemoveCart() {
            const d = document.getElementById('rem_cart');
            d.innerHTML = removeBuffer.length ? "" : "Vide";
            removeBuffer.forEach((i, idx) => {
                d.innerHTML += `<div class="rafale-item"><span>${i.qty}x ${i.type}</span><button style="background:red;border:none;color:white" onclick="delRem(${idx})">X</button></div>`;
            });
        }
        function delRem(i) { removeBuffer.splice(i, 1); renderRemoveCart(); }

        function commitRemove() {
            if(!removeBuffer.length) return;
            // Pour retirer, on doit lire et reecrire le tableau
            const docRef = db.collection("stocks").doc(currentMachine);
            db.runTransaction(async (t) => {
                const doc = await t.get(docRef);
                const data = doc.data();
                removeBuffer.forEach(item => {
                    const list = data[item.cat][item.type];
                    list.splice(-item.qty); // Enlever les derniers
                    data[item.cat][item.type] = list;
                });
                t.update(docRef, data);
            }).then(() => {
                alert("‚úÖ Retir√© !");
                removeBuffer = [];
                renderRemoveCart();
            }).catch(e => alert("Erreur: " + e));
        }

        // RAFALE
        function handleRafale(code) {
            let found = null;
            for(let c in stockData) {
                for(let t in stockData[c]) {
                    if(stockData[c][t].some(i => i.code === code)) found = {cat:c, type:t};
                }
            }
            if(found) {
                rafaleBuffer.push({...found, code, qty:1});
                renderRafale();
            } else {
                closeScanner();
                const t = prompt("Inconnu ! Nom ?");
                if(t) {
                    rafaleBuffer.push({cat:'filtration', type:t, code, qty:1});
                    startScanner('rafale');
                }
            }
        }

        function renderRafale() {
            const d = document.getElementById('rafale-list');
            d.innerHTML = "";
            rafaleBuffer.forEach(i => d.innerHTML += `<div class="rafale-item"><span>${i.type}</span><span>üì¶</span></div>`);
        }
        function clearRafale() { rafaleBuffer = []; renderRafale(); }

        function commitRafale() {
            if(!rafaleBuffer.length) return;
            const batch = db.batch();
            const docRef = db.collection("stocks").doc(currentMachine);
            
            // On le fait en mode simple merge
            // Note: batch ne marche pas bien pour merge deep fields avec arrayUnion sur meme doc plusieurs fois
            // On va faire update simple
            
            const updates = {};
            rafaleBuffer.forEach(item => {
                const k = `${item.cat}.${item.type}`;
                const val = {code: item.code, date: new Date().toISOString()};
                // Astuce: on groupe
            });
            
            // Pour faire simple et robuste: un par un ou group√© par type
            // On va utiliser la m√©thode simple du commitAdd en boucle (c'est sale mais √ßa marche) ou transaction
            // Mieux: on lit tout, on ajoute tout, on sauve tout.
            
            docRef.get().then(doc => {
                let data = doc.exists ? doc.data() : {};
                rafaleBuffer.forEach(item => {
                    if(!data[item.cat]) data[item.cat] = {};
                    if(!data[item.cat][item.type]) data[item.cat][item.type] = [];
                    data[item.cat][item.type].push({code: item.code, date: new Date().toISOString()});
                    
                    if(!CATEGORIES[item.cat].types.includes(item.type)) {
                        CATEGORIES[item.cat].types.push(item.type);
                        db.collection("config").doc("categories_stock").set(CATEGORIES, {merge:true});
                    }
                });
                docRef.set(data, {merge:true}).then(() => {
                    alert("‚úÖ Tout enregistr√© !");
                    clearRafale();
                });
            });
        }

        // PREVISION
        function renderPrevList() {
            const d = document.getElementById('prev-engins-list');
            d.innerHTML = "";
            DB_ENGINS[currentMachine].forEach((n, i) => {
                d.innerHTML += `<div class="prev-item"><input type="checkbox" id="chk_${i}"><label for="chk_${i}">${n}</label></div>`;
            });
        }

        function calcPrev() {
            let count = 0;
            DB_ENGINS[currentMachine].forEach((_, i) => { if(document.getElementById(`chk_${i}`).checked) count++; });
            if(!count) return alert("S√©lectionne un engin !");
            
            const d = document.getElementById('prev-res');
            let h = "";
            (CATEGORIES['filtration']?.types || []).forEach(t => {
                const s = stockData['filtration']?.[t]?.length || 0;
                const m = Math.max(0, count - s);
                const c = m > 0 ? "#f8d7da" : "#d4edda";
                h += `<div style="background:${c};padding:10px;margin:5px;border-radius:5px;"><strong>${t}</strong>: ${m>0 ? '‚ùå Manque '+m : '‚úÖ OK'} (${s})</div>`;
            });
            d.innerHTML = h;
        }

    </script>
</body>
</html>


