<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2MI STOCK - MASTER</title>
    
    <!-- Librairie Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* STYLE PROPRE ET ROBUSTE */
        :root { --primary: #E30066; --bg: #f4f4f9; --text: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--primary); color: white; padding-bottom: 100px; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }

        /* HEADER */
        .header { background: white; color: var(--primary); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .header h1 { font-weight: 900; font-size: 1.8rem; text-transform: uppercase; }
        .header p { font-weight: 600; color: #666; font-size: 0.9rem; }

        /* BOUTONS MACHINES */
        .grid-machines { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card-machine { background: white; color: #333; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .card-machine:active { transform: scale(0.96); }
        .icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }
        .name { font-weight: 800; color: var(--primary); text-transform: uppercase; font-size: 0.9rem; }

        /* NAVIGATION */
        .nav-bar { display: none; background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; justify-content: space-between; align-items: center; color: var(--primary); }
        .nav-bar.active { display: flex; }
        .nav-title { font-weight: 900; font-size: 1.2rem; }
        .btn-mini { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* MENU ACTIONS */
        .menu-actions { display: none; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-actions.active { display: grid; }
        .btn-menu { background: white; color: var(--primary); border: none; padding: 25px 10px; border-radius: 12px; font-weight: 800; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-menu:active { transform: scale(0.98); background: #eee; }
        .btn-rafale { grid-column: span 2; background: linear-gradient(135deg, #FFD700, #FFA500); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* SECTIONS */
        .section { display: none; background: white; color: #333; padding: 20px; border-radius: 15px; animation: slideUp 0.3s; }
        .section.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .section h2 { color: var(--primary); font-weight: 900; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: #fff; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 900; font-size: 1.1rem; color: white; background: var(--primary); margin-top: 10px; }
        .btn-scan { background: #28a745; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* LISTES & STOCK */
        .stock-cat { margin-bottom: 15px; }
        .stock-cat-title { background: #eee; padding: 8px 12px; border-radius: 6px; font-weight: 800; color: #555; margin-bottom: 5px; }
        .stock-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; }

        /* MODE RAFALE LISTE */
        .rafale-list { max-height: 250px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 15px 0; border: 1px solid #ddd; }
        .rafale-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; border-left: 4px solid #28a745; }

        /* SCANNER MODAL */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #reader { width: 100%; max-width: 400px; background: black; border-radius: 12px; overflow: hidden; border: 3px solid white; }

        /* ALERTS */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* AUTOCOMPLETE */
        .suggestions { position: relative; }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; z-index: 100; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; }
        .suggestion-item:hover { background: #f0f0f0; }

        /* PREVISION LIST */
        .prev-item { display: flex; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 6px; }
        .prev-item input { width: 20px; height: 20px; margin-right: 10px; }
    </style>
</head>
<body>

    <!-- MODAL SCANNER -->
    <div id="scanner-modal">
        <h2 style="color:white; margin-bottom:20px;">VISE LE CODE üì∑</h2>
        <div id="reader"></div>
        <button onclick="window.closeScanner()" class="btn-action" style="background:#dc3545; margin-top:20px; max-width:200px;">FERMER</button>
    </div>

    <div class="container">
        
        <div class="header">
            <h1>C2MI STOCK</h1>
            <p>Ma√Ætre Guigui Edition</p>
        </div>

        <!-- 1. CHOIX MACHINE -->
        <div id="view-machines" class="grid-machines"></div>

        <!-- BARRE NAVIGATION MACHINE -->
        <div id="machine-nav" class="nav-bar">
            <span class="nav-title" id="machine-title">--</span>
            <button class="btn-mini" onclick="window.goHome()">Changer</button>
        </div>

        <!-- 2. MENU ACTIONS -->
        <div id="view-menu" class="menu-actions">
            <button class="btn-menu" onclick="window.nav('stock')">üì¶ STOCK</button>
            <button class="btn-menu" onclick="window.nav('add')">‚ûï AJOUTER</button>
            <button class="menu-btn btn-menu" onclick="window.nav('remove')">‚ûñ RETIRER</button>
            <button class="btn-menu" onclick="window.nav('prev')">üìä PR√âVISION</button>
            <button class="btn-menu btn-rafale" onclick="window.nav('rafale')">üî´ MAGASINIER</button>
        </div>

        <!-- 3. SECTIONS -->

        <!-- STOCK -->
        <div id="sec-stock" class="section">
            <h2>üì¶ Inventaire Actuel</h2>
            <div id="stock-list">Chargement...</div>
            <button class="btn-action" style="background:#6c757d" onclick="window.goBack()">Retour Menu</button>
        </div>

        <!-- AJOUTER -->
        <div id="sec-add" class="section">
            <h2>‚ûï Entr√©e Stock</h2>
            <button class="btn-action btn-scan" onclick="window.startScanner('add')">üì∑ SCANNER</button>
            
            <div class="form-group">
                <label>Code</label>
                <input type="text" id="add_code" placeholder="Scan ou saisie..." oninput="window.checkCode(this.value)">
            </div>
            
            <div id="add_alert" class="alert alert-success" style="display:none">PRODUIT RECONNU ! ‚úÖ</div>

            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="add_cat" onchange="window.updateTypes('add')"></select>
            </div>

            <div class="form-group suggestions">
                <label>Type de pi√®ce</label>
                <input type="text" id="add_type" placeholder="Ex: Filtre Huile" oninput="window.filterTypes('add')" disabled>
                <div id="add_sugg" class="suggestions-list"></div>
            </div>

            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="add_qty" value="1" style="text-align:center; font-size:1.5rem; font-weight:bold;">
            </div>

            <button class="btn-action" onclick="window.commitAdd()">VALIDER</button>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="window.goBack()">Annuler</button>
        </div>

        <!-- RETIRER -->
        <div id="sec-remove" class="section">
            <h2>‚ûñ Sortie Stock</h2>
            <button class="btn-action btn-scan" onclick="window.startScanner('remove')">üì∑ SCANNER SORTIE</button>
            
            <div class="form-group">
                <label>Code (si manuel)</label>
                <input type="text" id="rem_code" placeholder="Scan ou saisie..." oninput="window.checkCodeRemove(this.value)">
            </div>

            <div id="rem_cart" class="rafale-list">
                <div style="text-align:center; color:#999; padding:20px;">Panier vide</div>
            </div>

            <button class="btn-action" onclick="window.commitRemove()">VALIDER SORTIE</button>
            
            <hr style="margin:20px 0;">
            <h3>Ajout Manuel</h3>
            <div class="form-group"><label>Cat√©gorie</label><select id="rem_cat" onchange="window.updateTypes('rem')"></select></div>
            <div class="form-group suggestions"><label>Type</label><input type="text" id="rem_type" disabled oninput="window.filterTypes('rem')"><div id="rem_sugg" class="suggestions-list"></div></div>
            <div class="form-group"><label>Qt√©</label><input type="number" id="rem_qty" value="1"></div>
            <button class="btn-action" style="background:#17a2b8" onclick="window.manualRemoveAdd()">Ajouter au panier</button>

            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="window.goBack()">Retour</button>
        </div>

        <!-- MAGASINIER (RAFALE) -->
        <div id="sec-rafale" class="section">
            <h2>üî´ Mode Rafale</h2>
            <p style="color:#666; margin-bottom:15px;">Scanne √† la cha√Æne. Tout s'ajoute √† la fin.</p>
            
            <button class="btn-action btn-scan" onclick="window.startScanner('rafale')">üöÄ D√âMARRER SCAN</button>

            <div id="rafale-list" class="rafale-list">
                <div style="text-align:center; padding:20px; color:#aaa;">En attente...</div>
            </div>

            <button class="btn-action" onclick="window.commitRafale()">ENREGISTRER TOUT ‚úÖ</button>
            <button class="btn-action" style="background:#dc3545; margin-top:10px" onclick="window.clearRafale()">Vider</button>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="window.goBack()">Retour</button>
        </div>

        <!-- PREVISION -->
        <div id="sec-prev" class="section">
            <h2>üìä Pr√©visions Maintenance</h2>
            <div id="prev-engins-list" style="margin-bottom:20px"></div>
            <button class="btn-action" onclick="window.calcPrev()">CALCULER</button>
            <div id="prev-res" style="margin-top:20px"></div>
            <button class="btn-action" style="background:#6c757d; margin-top:10px" onclick="window.goBack()">Retour</button>
        </div>

    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, child } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyDR1T9ss36NFuQWvq3ypwf7nUcqRhq5dQ8", authDomain: "maintenance-c2mi.firebaseapp.com", databaseURL: "https://maintenance-c2mi-default-rtdb.firebaseio.com", projectId: "maintenance-c2mi", storageBucket: "maintenance-c2mi.firebasestorage.app", messagingSenderId: "224545367081", appId: "1:224545367081:web:378d28b892528754c6a838" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DONNEES MAITRES ---
        const DB_ENGINS = {
            "4' AXE": ["TR 020", "TR 062", "TR 083", "TR 104", "TR 111", "TR 116", "TR 127", "TR 136", "TR 141"],
            "ELAN": ["C3 N¬∞235", "ELAN D : 032"],
            "SKYRAILLER": ["C14 N¬∞32", "C14 green N¬∞83"],
            "Pelle UNAC 22 TRR": ["N¬∞ 051", "N¬∞ 086", "N¬∞ 088"],
            "Debroussailleuse R/R": ["300RR N¬∞23", "300RR N¬∞24", "N¬∞ 27", "N¬∞ 30"],
            "ACX": ["ACX 01", "ACX 02"]
        };

        let CATEGORIES = {
            'filtration': { name: 'Filtration', types: ['Filtre Huile', 'Filtre Gasoil', 'Filtre Air'] },
            'freinage': { name: 'Freinage', types: ['Plaquettes', 'Disques'] }
        };

        let currentMachine = "";
        let stockData = {};
        let scanner = null;
        let scanMode = ""; 
        let rafaleBuffer = [];
        let removeBuffer = [];

        // --- GLOBAL FUNCTIONS ---
        // ON ATTACHE TOUT A WINDOW POUR EVITER LES BUGS DE SCOPE
        
        window.onload = () => {
            renderMachines();
            loadCategories();
        };

        function renderMachines() {
            const grid = document.getElementById('view-machines');
            grid.innerHTML = "";
            const icons = { "4' AXE": "üöÇ", "ELAN": "üöÖ", "SKYRAILLER": "üöÑ", "Pelle UNAC 22 TRR": "üèóÔ∏è", "Debroussailleuse R/R": "üåø", "ACX": "üöÜ" };
            
            for(let key in DB_ENGINS) {
                grid.innerHTML += `
                    <div class="card-machine" onclick="window.selectMachine('${key}')">
                        <span class="icon">${icons[key] || 'üöú'}</span>
                        <span class="name">${key}</span>
                    </div>
                `;
            }
        }

        function loadCategories() {
            const catRef = ref(db, 'categories_stock');
            onValue(catRef, (snap) => {
                if(snap.exists()) {
                    CATEGORIES = snap.val();
                } else {
                    set(catRef, CATEGORIES);
                }
                updateSelects();
            });
            updateSelects(); 
        }

        function updateSelects() {
            const ids = ['add_cat', 'rem_cat'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                el.innerHTML = '<option value="">-- Cat√©gorie --</option>';
                for(let k in CATEGORIES) {
                    el.innerHTML += `<option value="${k}">${CATEGORIES[k].name}</option>`;
                }
            });
        }

        // --- NAVIGATION ---
        window.selectMachine = (key) => {
            currentMachine = key;
            document.getElementById('view-machines').style.display = 'none';
            document.getElementById('machine-nav').classList.add('active');
            document.getElementById('machine-title').innerText = key;
            document.getElementById('view-menu').classList.add('active');

            // Charger le stock
            onValue(ref(db, `stock_filtres_v2/${currentMachine}`), (snap) => {
                stockData = snap.val() || {};
                renderStock();
            });
        };

        window.goHome = () => {
            currentMachine = "";
            document.getElementById('view-machines').style.display = 'grid';
            document.getElementById('machine-nav').classList.remove('active');
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
        };

        window.nav = (section) => {
            document.getElementById('view-menu').classList.remove('active');
            hideAllSections();
            document.getElementById(`sec-${section}`).classList.add('active');
            if(section === 'prev') renderPrevList();
            if(section === 'add' || section === 'remove') updateSelects();
        };

        window.goBack = () => {
            hideAllSections();
            document.getElementById('view-menu').classList.add('active');
        };

        function hideAllSections() {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        }

        // --- STOCK DISPLAY ---
        function renderStock() {
            const list = document.getElementById('stock-list');
            list.innerHTML = "";
            let empty = true;

            for(let catKey in CATEGORIES) {
                const catStock = stockData[catKey] || {};
                const types = Object.keys(catStock);
                
                if(types.length > 0) {
                    empty = false;
                    let html = `<div class="stock-cat"><div class="stock-cat-title">${CATEGORIES[catKey].name}</div>`;
                    types.forEach(t => {
                        html += `
                            <div class="stock-item">
                                <span>${t}</span>
                                <span class="badge">${catStock[t].length}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                    list.innerHTML += html;
                }
            }
            if(empty) list.innerHTML = "<div style='text-align:center; padding:20px; color:#999'>Stock vide pour cet engin.</div>";
        }

        // --- AJOUT ---
        window.checkCode = (code) => {
            const item = findItem(code);
            const alertBox = document.getElementById('add_alert');
            const catSel = document.getElementById('add_cat');
            const typeInp = document.getElementById('add_type');

            if(item) {
                alertBox.style.display = 'block';
                catSel.value = item.cat;
                window.updateTypes('add');
                setTimeout(() => typeInp.value = item.type, 50);
            } else {
                alertBox.style.display = 'none';
            }
        };

        function findItem(code) {
            for(let c in stockData) {
                for(let t in stockData[c]) {
                    if(stockData[c][t].some(i => i.code === code)) return {cat: c, type: t};
                }
            }
            return null;
        }

        window.updateTypes = (prefix) => {
            const cat = document.getElementById(`${prefix}_cat`).value;
            const inp = document.getElementById(`${prefix}_type`);
            inp.disabled = !cat;
            inp.value = "";
        };

        window.filterTypes = (prefix) => {
            const cat = document.getElementById(`${prefix}_cat`).value;
            const inp = document.getElementById(`${prefix}_type`);
            const sugg = document.getElementById(`${prefix}_sugg`);
            const val = inp.value.toLowerCase();
            
            if(!cat) return;

            const types = CATEGORIES[cat].types || [];
            const matches = types.filter(t => t.toLowerCase().includes(val));

            sugg.innerHTML = "";
            sugg.style.display = 'block';

            matches.forEach(t => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = t;
                div.onclick = () => { inp.value = t; sugg.style.display = 'none'; };
                sugg.appendChild(div);
            });

            if(val && !matches.includes(inp.value)) {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>+ Cr√©er "${inp.value}"</strong>`;
                div.onclick = () => {
                    if(!CATEGORIES[cat].types.includes(inp.value)) {
                        CATEGORIES[cat].types.push(inp.value);
                        set(ref(db, 'categories_stock'), CATEGORIES);
                    }
                    sugg.style.display = 'none';
                };
                sugg.appendChild(div);
            }
            document.addEventListener('click', (e) => {
                if(e.target !== inp) sugg.style.display = 'none';
            }, {once: true});
        };

        // --- SAUVEGARDE AJOUT ROBUSTE ---
        window.commitAdd = () => {
            const cat = document.getElementById('add_cat').value;
            const type = document.getElementById('add_type').value;
            const qty = parseInt(document.getElementById('add_qty').value);
            const code = document.getElementById('add_code').value;

            if(!cat || !type || !qty) return alert("Remplis tout !");

            const path = `stock_filtres_v2/${currentMachine}/${cat}/${type}`;
            
            // LECTURE DE LA DB AVANT D'ECRIRE POUR EVITER L'ECRASEMENT
            get(child(ref(db), path)).then((snapshot) => {
                let currentList = snapshot.val() || [];
                // S√©curit√© : conversion en tableau si bug
                if(!Array.isArray(currentList)) currentList = Object.values(currentList);

                for(let i=0; i<qty; i++) {
                    currentList.push({ code: code, date: new Date().toISOString() });
                }

                set(ref(db, path), currentList).then(() => {
                    alert("‚úÖ Stock ajout√© !");
                    document.getElementById('add_code').value = "";
                    document.getElementById('add_alert').style.display = 'none';
                    document.getElementById('add_qty').value = 1;
                }).catch(err => alert("Erreur sauvegarde: " + err));
            });
        };

        // --- SCANNER ---
        window.startScanner = (mode) => {
            scanMode = mode;
            document.getElementById('scanner-modal').style.display = 'flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                onScanSuccess
            ).catch(err => alert("Erreur Cam: " + err));
        };

        window.closeScanner = () => {
            if(scanner) scanner.stop().then(() => {
                scanner.clear();
                document.getElementById('scanner-modal').style.display = 'none';
            });
            else document.getElementById('scanner-modal').style.display = 'none';
        };

        function onScanSuccess(code) {
            if(scanMode === 'add') {
                document.getElementById('add_code').value = code;
                window.checkCode(code);
                window.closeScanner();
            }
            else if(scanMode === 'remove') {
                document.getElementById('rem_code').value = code;
                window.checkCodeRemove(code);
                window.closeScanner();
            }
            else if(scanMode === 'rafale') {
                handleRafale(code);
                scanner.pause();
                setTimeout(() => scanner.resume(), 1500);
            }
        }

        // --- RETRAIT ---
        window.checkCodeRemove = (code) => {
            const item = findItem(code);
            if(item) {
                addToRemoveCart(item.cat, item.type, 1);
                document.getElementById('rem_code').value = "";
            } else {
                alert("Produit inconnu dans ce stock.");
            }
        };

        window.manualRemoveAdd = () => {
            const cat = document.getElementById('rem_cat').value;
            const type = document.getElementById('rem_type').value;
            const qty = parseInt(document.getElementById('rem_qty').value);
            if(!cat || !type) return;
            addToRemoveCart(cat, type, qty);
        };

        function addToRemoveCart(cat, type, qty) {
            const dispo = stockData[cat]?.[type]?.length || 0;
            const inCart = removeBuffer.find(i => i.cat === cat && i.type === type)?.qty || 0;
            
            if(dispo < (qty + inCart)) return alert(`Pas assez de stock ! (Dispo: ${dispo})`);

            const existing = removeBuffer.find(i => i.cat === cat && i.type === type);
            if(existing) existing.qty += qty;
            else removeBuffer.push({cat, type, qty});
            
            renderRemoveCart();
        }

        function renderRemoveCart() {
            const div = document.getElementById('rem_cart');
            if(removeBuffer.length === 0) return div.innerHTML = "<div style='text-align:center;color:#999'>Vide</div>";
            
            div.innerHTML = "";
            removeBuffer.forEach((item, idx) => {
                div.innerHTML += `
                    <div class="rafale-item">
                        <span>${item.qty}x ${item.type}</span>
                        <button onclick="window.delRem(${idx})" style="background:red; color:white; border:none; padding:5px;">X</button>
                    </div>
                `;
            });
        }

        window.delRem = (idx) => { removeBuffer.splice(idx, 1); renderRemoveCart(); };

        window.commitRemove = () => {
            if(removeBuffer.length === 0) return;
            
            // Pour le retrait, on doit aussi lire la DB avant d'√©crire pour √™tre s√ªr
            // Mais comme c'est complexe de lire plusieurs paths, on fait un par un ou on trust le stockData local rafraichi
            // Ici m√©thode s√ªre : On met √† jour un par un
            
            let promises = removeBuffer.map(item => {
                const path = `stock_filtres_v2/${currentMachine}/${item.cat}/${item.type}`;
                return get(child(ref(db), path)).then(snap => {
                    let list = snap.val() || [];
                    for(let i=0; i<item.qty; i++) list.pop();
                    return set(ref(db, path), list);
                });
            });

            Promise.all(promises).then(() => {
                alert("‚úÖ Stock retir√© !");
                removeBuffer = [];
                renderRemoveCart();
            });
        };

        // --- RAFALE ---
        function handleRafale(code) {
            const item = findItem(code);
            if(item) {
                rafaleBuffer.push({ code, cat: item.cat, type: item.type, qty: 1 });
            } else {
                window.closeScanner();
                const typeName = prompt("Produit Inconnu ! Nom ?");
                if(typeName) {
                    rafaleBuffer.push({ code, cat: 'filtration', type: typeName, qty: 1 });
                    window.startScanner('rafale'); 
                }
            }
            renderRafale();
        }

        function renderRafale() {
            const div = document.getElementById('rafale-list');
            const groups = {};
            rafaleBuffer.forEach(i => {
                const k = i.type;
                if(!groups[k]) groups[k] = 0;
                groups[k] += i.qty;
            });
            
            div.innerHTML = "";
            for(let k in groups) {
                div.innerHTML += `<div class="rafale-item"><span>${groups[k]}x ${k}</span><span>üì¶</span></div>`;
            }
        }

        window.clearRafale = () => { rafaleBuffer = []; renderRafale(); };

        window.commitRafale = () => {
            if(rafaleBuffer.length === 0) return;
            
            // Grouper par type pour minimiser les √©critures
            const updates = {}; // cat|type -> [{code...}]

            rafaleBuffer.forEach(item => {
                const key = `${item.cat}|${item.type}`;
                if(!updates[key]) updates[key] = [];
                updates[key].push({code: item.code, date: new Date().toISOString()});
                
                // Save categorie if new
                if(CATEGORIES[item.cat] && !CATEGORIES[item.cat].types.includes(item.type)) {
                    CATEGORIES[item.cat].types.push(item.type);
                    set(ref(db, 'categories_stock'), CATEGORIES);
                }
            });

            // Ecriture S√ªre
            const promises = Object.keys(updates).map(key => {
                const [cat, type] = key.split('|');
                const path = `stock_filtres_v2/${currentMachine}/${cat}/${type}`;
                
                return get(child(ref(db), path)).then(snap => {
                    let list = snap.val() || [];
                    if(!Array.isArray(list)) list = Object.values(list);
                    list.push(...updates[key]);
                    return set(ref(db, path), list);
                });
            });

            Promise.all(promises).then(() => {
                alert(`‚úÖ Tout est enregistr√© !`);
                window.clearRafale();
            });
        };

        // --- PREVISION ---
        window.renderPrevList = () => {
            const div = document.getElementById('prev-engins-list');
            div.innerHTML = "";
            const list = DB_ENGINS[currentMachine] || [];
            list.forEach((nom, i) => {
                div.innerHTML += `
                    <div class="prev-item">
                        <input type="checkbox" id="chk_${i}">
                        <label for="chk_${i}">${nom}</label>
                    </div>
                `;
            });
        };

        window.calcPrev = () => {
            const list = DB_ENGINS[currentMachine] || [];
            let count = 0;
            list.forEach((_, i) => { if(document.getElementById(`chk_${i}`).checked) count++; });
            
            if(count === 0) return alert("S√©lectionne au moins un engin !");

            const res = document.getElementById('prev-res');
            let html = "";
            const types = CATEGORIES['filtration']?.types || ['Filtre Huile', 'Filtre Air']; 
            
            types.forEach(t => {
                const stock = stockData['filtration']?.[t]?.length || 0;
                const manq = Math.max(0, count - stock);
                const color = manq > 0 ? "alert-danger" : "alert-success";
                const txt = manq > 0 ? `‚ùå ${t} : Manque ${manq}` : `‚úÖ ${t} : OK`;
                html += `<div class="alert ${color}">${txt} (Stock: ${stock})</div>`;
            });
            res.innerHTML = html;
        };

    </script>
</body>
</html>


