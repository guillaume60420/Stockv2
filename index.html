<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2MI - Gestion Stock Pro</title>
    
    <!-- Librairie Scanner Robuste -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #E30066; color: white; min-height: 100vh; padding-bottom: 80px; }
        .container { max-width: 100%; margin: 0 auto; padding: 15px; }

        /* Header */
        .header { text-align: center; padding: 20px; background: white; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header h1 { color: #E30066; font-weight: 900; font-size: 1.8em; }
        .header p { color: #333; font-weight: 600; }

        /* Machines Grid */
        .machine-selection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .machine-selection.hidden { display: none; }
        .machine-card { background: white; border-radius: 12px; padding: 20px; text-align: center; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .machine-card:active { transform: scale(0.95); }
        .machine-icon { font-size: 2.5em; margin-bottom: 10px; }
        .machine-name { font-weight: 900; color: #E30066; text-transform: uppercase; }

        /* Machine Header */
        .machine-header { display: none; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .machine-header.active { display: block; }
        .machine-header h2 { color: #E30066; margin: 0; font-weight: 900; }
        .btn-change { background: #6c757d; border: none; padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold; margin-top: 10px; font-size: 0.8em; }

        /* Menu Principal */
        .menu-buttons { display: none; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-buttons.active { display: grid; }
        .menu-btn { background: white; border: none; padding: 25px 10px; border-radius: 12px; color: #E30066; font-weight: 900; font-size: 1.1em; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .menu-btn:active { transform: scale(0.95); background: #f8f9fa; }
        .btn-magasinier { grid-column: span 2; background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        /* Sections Contenu */
        .content-section { display: none; background: white; color: #333; padding: 20px; border-radius: 15px; margin-bottom: 20px; animation: slideUp 0.3s ease-out; }
        .content-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { color: #E30066; font-weight: 900; font-size: 1.5em; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }

        /* Stock Visuals */
        .category-block { margin-bottom: 20px; }
        .cat-title { background: #f1f3f5; padding: 10px; border-radius: 8px; color: #E30066; font-weight: bold; margin-bottom: 10px; }
        .stock-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .stock-qty { background: #E30066; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #E30066; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input, select { width: 100%; padding: 12px; border: 2px solid #E30066; border-radius: 8px; font-size: 1em; background: #fff; }
        input:disabled { background: #e9ecef; border-color: #ced4da; }

        /* Buttons */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 900; font-size: 1.1em; color: white; cursor: pointer; margin-bottom: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #E30066; }
        .btn-scan { background: #28a745; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-add { background: #17a2b8; }
        .btn-danger { background: #dc3545; }

        /* Mode Magasinier List */
        .rafale-list { background: #f8f9fa; border-radius: 10px; padding: 10px; margin: 15px 0; max-height: 300px; overflow-y: auto; }
        .rafale-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #28a745; }
        .rafale-info { font-size: 0.9em; font-weight: bold; }
        .rafale-cat { font-size: 0.75em; color: #666; }

        /* Scanner Modal */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #reader { width: 100%; max-width: 500px; background: black; border-radius: 15px; overflow: hidden; border: 4px solid #E30066; }
        
        /* Auto-complete List */
        .suggestions { position: relative; }
        .suggestions-list { position: absolute; width: 100%; background: white; border: 2px solid #E30066; border-top: none; z-index: 100; max-height: 200px; overflow-y: auto; display: none; border-radius: 0 0 8px 8px; }
        .suggestions-list.active { display: block; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 600; }
        .suggestion-item:hover { background: #fce4ec; }

        /* Alerts */
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 10px; font-weight: 600; font-size: 0.9em; }
        .alert-danger { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

    <!-- MODAL SCANNER -->
    <div id="scanner-modal">
        <h2 style="color:white; margin-bottom:20px;">üì∑ VISE LE CODE</h2>
        <div id="reader"></div>
        <button onclick="stopScanner()" class="btn btn-danger" style="max-width: 200px; margin-top: 20px;">FERMER</button>
    </div>

    <div class="container">
        
        <!-- HEADER -->
        <div class="header">
            <h1>üîß C2MI STOCK</h1>
            <p>Gestion Pro & Rapide</p>
        </div>

        <!-- SELECTION MACHINE (HOME) -->
        <div id="machineSelection" class="machine-selection"></div>

        <!-- HEADER MACHINE ACTIVE -->
        <div id="machineHeader" class="machine-header">
            <h2 id="machineTitle">--</h2>
            <button class="btn-change" onclick="goHome()">‚¨ÖÔ∏è Changer d'engin</button>
        </div>

        <!-- MENU PRINCIPAL -->
        <div id="menuButtons" class="menu-buttons">
            <button class="menu-btn" onclick="openSection('stock')">
                <span style="font-size:1.5em">üì¶</span> VOIR STOCK
            </button>
            <button class="menu-btn" onclick="openSection('ajouter')">
                <span style="font-size:1.5em">‚ûï</span> AJOUTER
            </button>
            <button class="menu-btn" onclick="openSection('retirer')">
                <span style="font-size:1.5em">‚ûñ</span> RETIRER
            </button>
            <button class="menu-btn" onclick="openSection('prevision')">
                <span style="font-size:1.5em">üìä</span> PR√âVISION
            </button>
            <button class="menu-btn btn-magasinier" onclick="openSection('magasinier')">
                <span style="font-size:1.5em">üî´</span> MODE MAGASINIER (RAFALE)
            </button>
        </div>

        <!-- SECTION 1: VOIR STOCK -->
        <div id="stockSection" class="content-section">
            <button class="back-btn" onclick="goBackToMenu()">‚¨ÖÔ∏è Menu</button>
            <h2 class="section-title">üì¶ Inventaire</h2>
            <div id="stockDisplay"></div>
        </div>

        <!-- SECTION 2: AJOUTER (SMART SCAN) -->
        <div id="ajouterSection" class="content-section">
            <button class="back-btn" onclick="goBackToMenu()">‚¨ÖÔ∏è Menu</button>
            <h2 class="section-title">‚ûï Entr√©e Stock</h2>
            
            <button class="btn btn-scan" onclick="startScan('add')">üì∑ SCANNER (AUTO)</button>
            
            <div class="form-group">
                <label>Code-Barres</label>
                <input type="text" id="add_code" placeholder="Scanne ou tape..." oninput="checkCodeKnowledge(this.value)">
            </div>

            <div id="add_known_alert" class="alert alert-success" style="display:none;">
                ‚ú® Produit reconnu ! Saisis juste la quantit√©.
            </div>

            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="add_cat" onchange="updateTypes('add')">
                    <option value="">Chargement...</option>
                </select>
                <button class="btn" style="background:#6c757d; margin-top:5px; font-size:0.8em; padding:8px;" onclick="newCategory()">+ Cr√©er cat√©gorie</button>
            </div>

            <div class="form-group suggestions">
                <label>Type de Pi√®ce</label>
                <input type="text" id="add_type" placeholder="Ex: Filtre Huile..." oninput="filterTypes('add')" onfocus="filterTypes('add')" disabled>
                <div id="add_suggestions" class="suggestions-list"></div>
            </div>

            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="add_qty" value="1" min="1" style="font-size:1.5em; text-align:center; font-weight:bold;">
            </div>

            <button class="btn btn-primary" onclick="commitAdd()">VALIDER L'ENTR√âE</button>
        </div>

        <!-- SECTION 3: RETIRER (SCAN DISPO) -->
        <div id="retirerSection" class="content-section">
            <button class="back-btn" onclick="goBackToMenu()">‚¨ÖÔ∏è Menu</button>
            <h2 class="section-title">‚ûñ Sortie Stock</h2>

            <button class="btn btn-scan" onclick="startScan('remove')">üì∑ SCANNER POUR RETIRER</button>

            <h3 style="color:#E30066; margin:15px 0;">Panier de retrait</h3>
            <div class="rafale-list" id="removeList">
                <div style="text-align:center; color:#999; padding:20px;">Panier vide</div>
            </div>
            
            <button class="btn btn-primary" onclick="commitRemove()">VALIDER LA SORTIE</button>

            <hr style="margin:20px 0; border-top:2px dashed #eee;">
            
            <h3 style="color:#666; font-size:1em;">Ajout Manuel</h3>
            <div class="form-group">
                <label>Cat√©gorie</label>
                <select id="rem_cat" onchange="updateTypes('rem')">
                    <option value="">Chargement...</option>
                </select>
            </div>
            <div class="form-group suggestions">
                <label>Type</label>
                <input type="text" id="rem_type" disabled oninput="filterTypes('rem')" onfocus="filterTypes('rem')">
                <div id="rem_suggestions" class="suggestions-list"></div>
            </div>
            <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" id="rem_qty" value="1" min="1">
            </div>
            <button class="btn" style="background:#6c757d;" onclick="manualAddToRemove()">Ajouter au panier</button>
        </div>

        <!-- SECTION 4: MAGASINIER (RAFALE) -->
        <div id="magasinierSection" class="content-section">
            <button class="back-btn" onclick="goBackToMenu()">‚¨ÖÔ∏è Menu</button>
            <h2 class="section-title">üî´ Mode Rafale</h2>
            <p style="color:#666; margin-bottom:15px; font-size:0.9em;">Scanne √† la suite. Le stock se mettra √† jour d'un coup.</p>

            <button class="btn btn-scan" onclick="startScan('rafale')">üöÄ D√âMARRER LE SCAN RAFALE</button>

            <div id="rafaleList" class="rafale-list">
                <div style="text-align:center; padding:20px; color:#aaa;">En attente de scan...</div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="clearRafale()">VIDER</button>
                <button class="btn btn-primary" onclick="commitRafale()">TOUT ENREGISTRER ‚úÖ</button>
            </div>
        </div>

        <!-- SECTION 5: PREVISION -->
        <div id="previsionSection" class="content-section">
            <button class="back-btn" onclick="goBackToMenu()">‚¨ÖÔ∏è Menu</button>
            <h2 class="section-title">üìä Pr√©visions</h2>
            <div id="enginsListPrev" style="margin-bottom:15px;"></div>
            <button class="btn btn-primary" onclick="calcPrevision()">Lancer Analyse</button>
            <div id="prevResults" style="margin-top:15px;"></div>
        </div>

    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = { apiKey: "AIzaSyDR1T9ss36NFuQWvq3ypwf7nUcqRhq5dQ8", authDomain: "maintenance-c2mi.firebaseapp.com", databaseURL: "https://maintenance-c2mi-default-rtdb.firebaseio.com", projectId: "maintenance-c2mi", storageBucket: "maintenance-c2mi.firebasestorage.app", messagingSenderId: "224545367081", appId: "1:224545367081:web:378d28b892528754c6a838" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DONNEES ---
        const dbEngins = {
            "4' AXE": ["TR 020", "TR 062", "TR 083", "TR 104", "TR 111", "TR 116", "TR 127", "TR 136", "TR 141"],
            "ELAN": ["C3 N¬∞235", "ELAN D : 032"],
            "SKYRAILLER": ["C14 N¬∞32", "C14 green N¬∞83"],
            "Pelle UNAC 22 TRR": ["N¬∞ 051", "N¬∞ 086", "N¬∞ 088"],
            "Debroussailleuse R/R": ["300RR N¬∞23", "300RR N¬∞24", "N¬∞ 27", "N¬∞ 30"],
            "ACX": ["ACX 01", "ACX 02"]
        };

        let currentMachine = '';
        let stockData = {};
        // Initialisation par d√©faut pour √©viter l'affichage vide
        let categories = {
            'filtration': { name: 'Filtration', types: ['Filtre Huile', 'Filtre Gasoil', 'Filtre Air'] },
            'freinage': { name: 'Freinage', types: ['Plaquettes', 'Disques'] }
        };
        let html5QrcodeScanner = null;
        let scanMode = ''; 
        let rafaleBuffer = [];
        let removeBuffer = [];

        // --- INIT ---
        window.onload = () => {
            initMachineMenu();
            syncCategories(); // Lance la synchro Firebase
        };

        function initMachineMenu() {
            const grid = document.getElementById('machineSelection');
            grid.innerHTML = '';
            const icons = { "4' AXE": "üöÇ", "ELAN": "üöÖ", "SKYRAILLER": "üöÑ", "Pelle UNAC 22 TRR": "üèóÔ∏è", "Debroussailleuse R/R": "üåø", "ACX": "üöÜ" };
            
            for (let type in dbEngins) {
                const div = document.createElement('div');
                div.className = 'machine-card';
                div.innerHTML = `<div class="machine-icon">${icons[type]||'üöú'}</div><div class="machine-name">${type}</div>`;
                div.onclick = () => selectMachine(type);
                grid.appendChild(div);
            }
        }

        function syncCategories() {
            // Afficher les cat√©gories par d√©faut imm√©diatement
            updateAllSelects();

            // Puis r√©cup√©rer les vraies de Firebase
            const catRef = ref(db, 'categories_stock');
            onValue(catRef, (snap) => {
                if (snap.exists()) {
                    categories = snap.val();
                } else {
                    // Si vide sur Firebase, on envoie les d√©fauts
                    set(catRef, categories);
                }
                updateAllSelects();
            });
        }

        // --- NAVIGATION ---
        window.selectMachine = function(machine) {
            currentMachine = machine;
            document.getElementById('machineSelection').classList.add('hidden');
            document.getElementById('machineHeader').classList.add('active');
            document.getElementById('machineTitle').innerText = machine;
            document.getElementById('menuButtons').classList.add('active');
            
            onValue(ref(db, 'stock_filtres_v2/' + machine), (snap) => {
                stockData = snap.val() || {};
                renderStock();
            });
        }

        window.goHome = function() {
            document.getElementById('machineHeader').classList.remove('active');
            document.getElementById('menuButtons').classList.remove('active');
            closeAllSections();
            document.getElementById('machineSelection').classList.remove('hidden');
            currentMachine = '';
        }

        window.openSection = function(id) {
            document.getElementById('menuButtons').classList.remove('active');
            closeAllSections();
            document.getElementById(id + 'Section').classList.add('active');
            
            if(id === 'prevision') renderPrevisionList();
            if(id === 'ajouter' || id === 'retirer') updateAllSelects();
        }

        window.goBackToMenu = function() {
            closeAllSections();
            document.getElementById('menuButtons').classList.add('active');
        }

        function closeAllSections() {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        }

        // --- AFFICHAGE STOCK ---
        function renderStock() {
            const div = document.getElementById('stockDisplay');
            div.innerHTML = '';
            
            let hasStock = false;

            for (let [catId, catData] of Object.entries(categories)) {
                const stockCat = stockData[catId] || {};
                const typesInStock = Object.keys(stockCat);
                if (typesInStock.length === 0) continue;

                hasStock = true;
                const block = document.createElement('div');
                block.className = 'category-block';
                block.innerHTML = `<div class="cat-title">üìÇ ${catData.name}</div>`;

                let content = '';
                typesInStock.forEach(type => {
                    const count = (stockCat[type] || []).length;
                    content += `
                        <div class="stock-row">
                            <span style="font-weight:600">${type}</span>
                            <span class="stock-qty">${count}</span>
                        </div>
                    `;
                });
                block.innerHTML += content;
                div.appendChild(block);
            }

            if(!hasStock) div.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Stock vide pour cet engin.</div>';
        }

        // --- SCANNER SYSTEM ---
        window.startScan = function(mode) {
            scanMode = mode;
            document.getElementById('scanner-modal').style.display = 'flex';
            
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    handleScanResult(decodedText);
                    if(scanMode !== 'rafale') stopScanner(); 
                    else {
                        // Pause pour √©viter les doublons instantan√©s
                        html5QrcodeScanner.pause();
                        setTimeout(() => html5QrcodeScanner.resume(), 1500);
                    }
                },
                (errorMessage) => { /* ignore */ }
            ).catch(err => alert("Erreur Cam√©ra: " + err));
        }

        window.stopScanner = function() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('scanner-modal').style.display = 'none';
                    html5QrcodeScanner.clear();
                });
            } else {
                document.getElementById('scanner-modal').style.display = 'none';
            }
        }

        // --- LOGIQUE INTELLIGENTE ---
        function findItemByCode(code) {
            for(let cat in stockData) {
                for(let type in stockData[cat]) {
                    const items = stockData[cat][type];
                    if(items.some(i => i.code === code)) return { cat, type };
                }
            }
            // Recherche aussi dans l'historique global si besoin (optionnel)
            return null;
        }

        function handleScanResult(code) {
            // Son
            const audio = new AudioContext();
            const osc = audio.createOscillator();
            const gain = audio.createGain();
            osc.connect(gain); gain.connect(audio.destination);
            osc.frequency.value = 1000; gain.gain.value = 0.1;
            osc.start(); setTimeout(() => osc.stop(), 100);

            if (scanMode === 'add') {
                document.getElementById('add_code').value = code;
                window.checkCodeKnowledge(code);
            } 
            else if (scanMode === 'remove') {
                const info = findItemByCode(code);
                if (info) {
                    addToRemoveBuffer(info.cat, info.type, 1);
                    alert(`‚úÖ ${info.type} ajout√© au panier.`);
                } else {
                    alert("‚ö†Ô∏è Produit inconnu dans le stock de CET engin.");
                }
            }
            else if (scanMode === 'rafale') {
                handleRafaleScan(code);
            }
        }

        // --- MODE AJOUT ---
        window.checkCodeKnowledge = function(code) {
            const info = findItemByCode(code);
            const alertBox = document.getElementById('add_known_alert');
            const catSelect = document.getElementById('add_cat');
            const typeInput = document.getElementById('add_type');

            if (info) {
                alertBox.style.display = 'block';
                catSelect.value = info.cat;
                updateTypes('add'); 
                setTimeout(() => { 
                    typeInput.value = info.type;
                    document.getElementById('add_qty').focus();
                }, 100);
            } else {
                alertBox.style.display = 'none';
            }
        }

        window.updateTypes = function(prefix) {
            const cat = document.getElementById(prefix + '_cat').value;
            const input = document.getElementById(prefix + '_type');
            input.disabled = !cat;
            input.value = '';
        }

        window.filterTypes = function(prefix) {
            const cat = document.getElementById(prefix + '_cat').value;
            const input = document.getElementById(prefix + '_type');
            const list = document.getElementById(prefix + '_suggestions');
            
            if(!cat) return;
            const val = input.value.toLowerCase();
            const types = categories[cat].types || [];
            
            list.innerHTML = '';
            const filtered = types.filter(t => t.toLowerCase().includes(val));
            
            filtered.forEach(t => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = t;
                div.onclick = () => { input.value = t; list.classList.remove('active'); };
                list.appendChild(div);
            });

            if(val.length > 0 && !filtered.includes(input.value)) {
                const create = document.createElement('div');
                create.className = 'suggestion-item';
                create.innerHTML = `<strong>‚ûï Cr√©er "${input.value}"</strong>`;
                create.onclick = () => { 
                    if(!categories[cat].types.includes(input.value)) {
                        categories[cat].types.push(input.value);
                        set(ref(db, 'categories_stock'), categories);
                    }
                    list.classList.remove('active');
                };
                list.appendChild(create);
            }

            list.classList.add('active');
            
            document.addEventListener('click', e => {
                if(e.target !== input) list.classList.remove('active');
            }, {once:true});
        }

        window.commitAdd = function() {
            const code = document.getElementById('add_code').value;
            const cat = document.getElementById('add_cat').value;
            const type = document.getElementById('add_type').value;
            const qty = parseInt(document.getElementById('add_qty').value);

            if(!cat || !type || !qty) return alert("Remplis tout !");

            const path = `stock_filtres_v2/${currentMachine}/${cat}/${type}`;
            const currentList = stockData[cat]?.[type] || [];
            
            for(let i=0; i<qty; i++) currentList.push({code, date: new Date().toISOString()});
            
            set(ref(db, path), currentList).then(() => {
                alert(`‚úÖ +${qty} ${type} ajout√©s !`);
                document.getElementById('add_code').value = '';
                document.getElementById('add_known_alert').style.display = 'none';
                document.getElementById('add_qty').value = 1;
                document.getElementById('add_type').value = '';
            });
        }

        // --- MODE RETRAIT ---
        function addToRemoveBuffer(cat, type, qty) {
            const dispo = (stockData[cat]?.[type] || []).length;
            const existing = removeBuffer.find(i => i.cat === cat && i.type === type);
            const qtyInCart = existing ? existing.qty : 0;

            if (dispo < (qty + qtyInCart)) return alert(`Stock insuffisant ! (Dispo: ${dispo})`);

            if (existing) {
                existing.qty += qty;
            } else {
                removeBuffer.push({cat, type, qty});
            }
            renderRemoveList();
        }

        window.manualAddToRemove = function() {
            const cat = document.getElementById('rem_cat').value;
            const type = document.getElementById('rem_type').value;
            const qty = parseInt(document.getElementById('rem_qty').value);
            if(!cat || !type) return;
            addToRemoveBuffer(cat, type, qty);
        }

        function renderRemoveList() {
            const div = document.getElementById('removeList');
            if(removeBuffer.length === 0) {
                div.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Panier vide</div>';
                return;
            }
            div.innerHTML = '';
            removeBuffer.forEach((item, idx) => {
                div.innerHTML += `
                    <div class="rafale-item">
                        <div>
                            <div class="rafale-info">${item.qty}x ${item.type}</div>
                            <div class="rafale-cat">${categories[item.cat].name}</div>
                        </div>
                        <button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="removeFromRemoveList(${idx})">X</button>
                    </div>
                `;
            });
        }

        window.removeFromRemoveList = function(idx) {
            removeBuffer.splice(idx, 1);
            renderRemoveList();
        }

        window.commitRemove = function() {
            if(removeBuffer.length === 0) return;
            removeBuffer.forEach(item => {
                const list = stockData[item.cat][item.type];
                for(let i=0; i<item.qty; i++) list.pop(); 
            });
            set(ref(db, `stock_filtres_v2/${currentMachine}`), stockData).then(() => {
                alert("‚úÖ Stock mis √† jour !");
                removeBuffer = [];
                renderRemoveList();
            });
        }

        // --- MODE MAGASINIER (RAFALE) ---
        function handleRafaleScan(code) {
            let info = findItemByCode(code);
            
            if (info) {
                rafaleBuffer.push({ code, cat: info.cat, type: info.type, qty: 1 });
                renderRafaleList();
            } else {
                // Pour √©viter de bloquer le scan trop longtemps, on demande vite fait
                // Mais sur mobile les prompts c'est pas ouf. 
                // V1: On demande via prompt
                // V2 (Am√©lioration): On met en liste "Inconnu" et on traite apr√®s. 
                // Ici on reste simple :
                stopScanner();
                const typeName = prompt("Produit Inconnu ! Nom du produit ?");
                if(typeName) {
                    // On suppose cat√©gorie filtration par d√©faut si inconnu pour aller vite
                    const defCat = 'filtration';
                    rafaleBuffer.push({ code, cat: defCat, type: typeName, qty: 1 });
                    renderRafaleList();
                }
                // Pas de restart auto pour laisser l'user respirer
            }
        }

        function renderRafaleList() {
            const div = document.getElementById('rafaleList');
            const groups = {};
            rafaleBuffer.forEach(i => {
                const key = i.cat + '|' + i.type;
                if(!groups[key]) groups[key] = 0;
                groups[key] += i.qty;
            });

            if(Object.keys(groups).length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">En attente de scan...</div>';
                return;
            }

            div.innerHTML = '';
            for(let key in groups) {
                const [cat, type] = key.split('|');
                div.innerHTML += `
                    <div class="rafale-item">
                        <div>
                            <div class="rafale-info">${groups[key]}x ${type}</div>
                            <div class="rafale-cat">${categories[cat]?.name || cat}</div>
                        </div>
                        <span style="font-size:1.5em">üì¶</span>
                    </div>
                `;
            }
        }

        window.clearRafale = function() {
            rafaleBuffer = [];
            renderRafaleList();
        }

        window.commitRafale = function() {
            if(rafaleBuffer.length === 0) return;
            rafaleBuffer.forEach(item => {
                if(!stockData[item.cat]) stockData[item.cat] = {};
                if(!stockData[item.cat][item.type]) stockData[item.cat][item.type] = [];
                stockData[item.cat][item.type].push({ code: item.code, date: new Date().toISOString() });
                
                if(categories[item.cat] && !categories[item.cat].types.includes(item.type)) {
                    categories[item.cat].types.push(item.type);
                }
            });
            set(ref(db, 'categories_stock'), categories);
            set(ref(db, `stock_filtres_v2/${currentMachine}`), stockData).then(() => {
                alert(`‚úÖ ${rafaleBuffer.length} articles ajout√©s !`);
                clearRafale();
            });
        }

        // --- PREVISIONS ---
        function renderPrevisionList() {
            const div = document.getElementById('enginsListPrev');
            div.innerHTML = '';
            const engins = dbEngins[currentMachine] || [];
            engins.forEach((nom, i) => {
                div.innerHTML += `
                    <div style="background:#f8f9fa; padding:10px; margin-bottom:5px; border-radius:8px; display:flex; align-items:center;">
                        <input type="checkbox" id="prev_check_${i}" style="width:20px; height:20px; margin-right:10px;">
                        <label for="prev_check_${i}" style="color:#333; margin:0;">${nom}</label>
                    </div>
                `;
            });
        }

        window.calcPrevision = function() {
            let count = 0;
            const engins = dbEngins[currentMachine] || [];
            engins.forEach((e, i) => {
                if(document.getElementById(`prev_check_${i}`).checked) count++;
            });

            const resDiv = document.getElementById('prevResults');
            if(count === 0) {
                resDiv.innerHTML = '<div class="alert alert-danger">S√©lectionne au moins un engin !</div>';
                return;
            }

            let html = `<h3>Besoin pour ${count} intervention(s)</h3>`;
            const typesCheck = categories['filtration']?.types || [];
            
            typesCheck.forEach(type => {
                const stock = (stockData['filtration']?.[type] || []).length;
                const manque = Math.max(0, count - stock);
                if(manque > 0) html += `<div class="alert alert-danger">‚ùå <strong>${type}</strong> : Manque ${manque} (Stock: ${stock})</div>`;
                else html += `<div class="alert alert-success">‚úÖ <strong>${type}</strong> : OK (Stock: ${stock})</div>`;
            });
            resDiv.innerHTML = html;
        }

        // --- UTILS UI (CORRECTION AFFICHAGE CATEGORIE) ---
        function updateAllSelects() {
            const ids = ['add_cat', 'rem_cat'];
            ids.forEach(id => {
                const select = document.getElementById(id);
                if(!select) return;
                
                // On vide d'abord
                select.innerHTML = '<option value="">-- Choisir Cat√©gorie --</option>';
                
                // On remplit proprement
                Object.keys(categories).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.text = categories[key].name;
                    select.add(opt);
                });
            });
        }

        window.newCategory = function() {
            const nom = prompt("Nom de la cat√©gorie ?");
            if(!nom) return;
            const id = nom.toLowerCase().replace(/\s/g, '_');
            categories[id] = { name: nom, types: [] };
            set(ref(db, 'categories_stock'), categories);
            updateAllSelects();
        }

    </script>
</body>
</html>


